Ext.define('SearchPanel',{extend:'Ext.toolbar.Toolbar',alias:'widget.searchpanel',searchField:null,resetButton:null,store:null,fieldNames:[],local:!1,lastQuery:'',searchParam:'search',fieldLabel:null,hideLabel:!1,minChars:1,reloadToFirstPage:!0,constructor:function(config){config=Ext.apply({border:!1,bodyBorder:!1,width:230,hideLabel:!1,frame:!1,style:{border:0},fieldLabel:appLang.SEARCH+':'},config||{});this.callParent(arguments)},initComponent:function(){this.resetButton=Ext.create('Ext.Button',{iconCls:'deleteIcon',flat:!1,tooltip:appLang.RESET,listeners:{'click':{fn:function(){this.searchField.setValue('');this.clearFilter()},scope:this}}});this.searchField=Ext.create('Ext.form.field.Text',{enableKeyEvents:!0,flex:2,listeners:{'keyup':{fn:this.startFilter,buffer:700,scope:this}}});this.items=[];if(!this.hideLabel){this.items.push(this.fieldLabel)}
this.items.push(this.searchField,this.resetButton);this.callParent(arguments)},clearFilter:function(){this.store.clearFilter();this.lastQuery='';if(!this.local){this.store.proxy.setExtraParam(this.searchParam,'');this.store.load({scope:this,callback:function(records,operation,success){this.fireEvent('reset')}})}else{this.fireEvent('reset')}},startFilter:function(){var query=this.searchField.getValue();if(this.lastQuery===query){return}
if(query.length<this.minChars){return}
if(this.local){this.clearFilter();this.store.filter({fn:this.isSearched,scope:this})}else{this.store.getProxy().setExtraParam(this.searchParam,this.searchField.getValue());if(this.reloadToFirstPage){this.store.loadPage(1)}else{this.store.load()}}
this.lastQuery=query},isSearched:function(record){var flag=!1;var recordHandle=record;var searchText=this.searchField.getValue();var pattern=new RegExp(searchText,"gi");Ext.each(this.fieldNames,function(item){if(pattern.exec(recordHandle.get(item))!=null){flag=!0;return}},this);return flag},setValue:function(text){this.searchField.setValue(text);this.startFilter()},getValue:function(){return this.searchField.getValue()},destroy:function(){this.searchField.destroy();this.resetButton.destroy();this.callParent(arguments)}});Ext.ns('designer.importDBWindow.js');Ext.define('designer.importDBWindow',{extend:'Ext.window.Window',controllerUrl:null,connectionField:null,tableField:null,dataForm:null,fieldsGrid:null,initComponent:function(){this.modal=!0;this.width=400;this.height=450;this.layout='fit';this.controllerUrl=app.createUrl([designer.controllerUrl,'db','']);this.typeField=Ext.create('Ext.form.field.ComboBox',{typeAhead:!1,triggerAction:'all',forceSelection:!0,displayField:'title',valueField:'id',allowBlank:!1,fieldLabel:desLang.type,store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'integer'},{name:'title',type:'string'}],proxy:{type:'ajax',url:app.createUrl([app.admin,'orm','connectiontypes']),reader:{type:'json',rootProperty:'data',idProperty:'id'}},autoLoad:!0,sorters:[{property:'title',direction:'ASC'}]}),listeners:{select:function(field,record,options){this.tableField.getStore().proxy.setExtraParam('type',record.get('id'));if(this.tableField.getStore().proxy.extraParams.connId){this.tableField.getStore().load()}
this.fieldsGrid.getStore().removeAll()},scope:this}});this.connectionField=Ext.create('Ext.form.field.ComboBox',{fieldLabel:desLang.connection,queryMode:'local',typeAhead:!0,forceSelection:!0,displayField:'id',valueField:'id',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:app.createUrl([app.admin,'orm','connectionslist']),reader:{type:'json',rootProperty:'data',idProperty:'id'}},autoLoad:!0,sorters:[{property:'id',direction:'ASC'}]}),listeners:{select:function(field,record,options){this.tableField.getStore().proxy.setExtraParam('connId',record.get('id'));if(this.tableField.getStore().proxy.extraParams.type){this.tableField.getStore().load()}
this.fieldsGrid.getStore().removeAll()},scope:this}});this.tableField=Ext.create('Ext.form.field.ComboBox',{fieldLabel:desLang.table,queryMode:'local',forceSelection:!0,displayField:'title',typeAhead:!0,valueField:'id',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:app.createUrl([app.admin,'orm','connections','tablelist']),reader:{type:'json',rootProperty:'data',idProperty:'id'}},autoLoad:!1,sorters:[{property:'title',direction:'ASC'}]}),listeners:{select:function(field,records,options){this.fieldsGrid.getStore().proxy.setExtraParam('type',this.typeField.getValue());this.fieldsGrid.getStore().proxy.setExtraParam('connId',this.connectionField.getValue());this.fieldsGrid.getStore().proxy.setExtraParam('table',field.getValue());this.fieldsGrid.getStore().load()},scope:this}});this.fieldsGrid=Ext.create('Ext.grid.Panel',{title:desLang.fields,height:300,scrollable:!0,selModel:Ext.create('Ext.selection.CheckboxModel',{}),store:Ext.create('Ext.data.Store',{fields:[{name:'name',type:'string'},{name:'type',type:'string'}],proxy:{url:app.createUrl([app.admin,'orm','connections','fieldslist']),type:'ajax',reader:{type:'json',idProperty:'name',rootProperty:'data'}},autoLoad:!1,sorters:[{property:'name',direction:'ASC'}]}),columns:[{text:desLang.name,dataIndex:'name',flex:1},{text:desLang.type,dataIndex:'type',flex:1}]});this.dataForm=Ext.create('Ext.form.Panel',{border:!1,bodyPadding:15,bodyCls:'formBody',layout:'anchor',defaults:{anchor:'100%'},items:[this.connectionField,this.typeField,this.tableField,this.fieldsGrid]});this.items=[this.dataForm];this.buttons=[{text:desLang.select,scope:this,handler:this.onSelect},{text:desLang.cancel,scope:this,handler:this.close}];this.callParent(arguments)},onSelect:function(){var fSm=this.fieldsGrid.getSelectionModel();if(!fSm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,desLang.selectFields);return}
var selection=fSm.getSelection();var names=[];Ext.each(selection,function(item,index){names.push(item.get('name'))},this);this.fireEvent('select',names,this.connectionField.getSubmitValue(),this.tableField.getSubmitValue(),this.typeField.getSubmitValue());this.close()}});Ext.ns('designer');designer.controllerUrl='';designer.msgCt=!1;designer.createBox=function(t,s){return'<div class="msg"><h3>'+t+'</h3><p>'+s+'</p></div>'};designer.msg=function(title,text){if(!designer.msgCt){designer.msgCt=Ext.core.DomHelper.insertFirst(document.body,{id:'msg-div'},!0)}
var s=Ext.String.format.apply(String,Array.prototype.slice.call(arguments,1));var m=Ext.core.DomHelper.append(designer.msgCt,designer.createBox(title,s),!0);m.hide();m.slideIn('t').ghost("t",{delay:3000,remove:!0})};Ext.define('designer.application',{extend:'Ext.Panel',rightPanel:null,centerPanel:null,projectItems:null,rightBottom:null,componentsBar:null,topToolbar:null,codeEditor:null,preCodeEditor:null,eventsEditor:null,methodsEditor:null,viewSwitch:null,codeSwitch:null,activePropertyPanel:null,externalCommandReceiver:null,needRefresh:!1,projectPathLabel:null,autoRefreshSwitch:null,frameFirstLoad:!0,activeFrameEl:null,frame1:null,initComponent:function(){this.initCommandReceiver();this.initLayout();this.initToolbars();this.callParent();this.on('afterrender',function(){this.initFrame();this.checkIsLoaded()},this)},initCommandReceiver:function(){var me=this;if(window.addEventListener){window.addEventListener("message",function(event){me.onCommand(event)})}else{window.attachEvent("onmessage",function(event){me.onCommand(event)})}},onCommand:function(event){var message=event.data;if(event.origin!=window.location.origin){return}
if(message.command&&message.params){this.runCommand(message.command,message.params)}},runCommand:function(command,params){switch(command){case 'windowSizeChanged':designer.msg(desLang.success,desLang.windowSizeChanged);break;case 'columnSizeChanged':designer.msg(desLang.success,desLang.columnSizeChanged);break;case 'columnMoved':designer.msg(desLang.success,desLang.columnMoved);break}},initLayout:function(){this.layout='border';this.projectItems=Ext.create('designer.objects.Manager',{region:'north',split:!0,height:300,collapsible:!0,controllerUrl:app.createUrl([designer.controllerUrl,'objects','']),listeners:{itemSelected:{fn:this.showProperties,scope:this},dataChanged:{fn:this.refreshCodeframe,scope:this},objectRemoved:{fn:function(){this.propertiesPanel.removeAll();this.propertiesPanel.setTitle('')},scope:this}}});this.propertiesPanel=Ext.create('Ext.Panel',{region:'center',split:!0,layout:'fit',title:desLang.properties,collapsible:!1,border:!1});this.rightPanel=Ext.create('Ext.Panel',{region:'east',title:desLang.projectTree,split:!0,minWidth:250,width:350,collapsible:!0,layout:'border',items:[this.projectItems,this.propertiesPanel]});this.centerPanel=Ext.create('Ext.Panel',{region:'center',border:!1,split:!0,layout:'fit'});this.codeEditor=Ext.create('designer.codeEditor',{title:desLang.codeEditor,disabled:!0,controllerUrl:app.createUrl([designer.controllerUrl,'actionjs',''])});this.preCodeEditor=Ext.create('designer.codeEditor',{title:desLang.preCodeEditor,disabled:!0,controllerUrl:app.createUrl([designer.controllerUrl,'preprojectjs',''])});this.eventsEditor=Ext.create('designer.eventsEditor',{title:desLang.eventsEditor,disabled:!0,controllerUrl:app.createUrl([designer.controllerUrl,'events','']),listeners:{'eventsUpdated':{fn:function(){this.onChange();if(!Ext.isEmpty(this.activePropertyPanel)){this.activePropertyPanel.refreshEvents()}},scope:this}}});this.methodsEditor=Ext.create('designer.methodsEditor',{title:desLang.methodsEditor,disabled:!0,controllerUrl:app.createUrl([designer.controllerUrl,'methods','']),listeners:{'methodsUpdated':{fn:function(){this.onChange();if(!Ext.isEmpty(this.activePropertyPanel)){this.activePropertyPanel.refreshMethods()}},scope:this}}});var bottomTabs=Ext.create('Ext.tab.Panel',{deferredRender:!1,frame:!1,layout:'fit',items:[this.codeEditor,this.preCodeEditor,this.eventsEditor,this.methodsEditor],listeners:{activate:{fn:function(tab,opt){this.codeEditor.syncEditor();this.preCodeEditor.syncEditor()},scope:this}}});this.contentContainer=Ext.create('Ext.Container',{layout:'card',activeItem:0,deferredRender:!1,header:!1,region:'center',items:[this.centerPanel,bottomTabs]});this.items=[this.rightPanel,this.contentContainer]},initToolbars:function(){var pressed=app.cookieProvider.get('autoRefresh');if(pressed===undefined){pressed=!0}
this.autoRefreshSwitch=Ext.create('Ext.button.Button',{tooltip:desLang.autoRefresh,iconCls:'autoRefreshIcon',showType:'loaded',scope:this,enableToggle:!0,pressed:pressed,listeners:{scope:this,toggle:function(btn,pressed){app.cookieProvider.set('autoRefresh',pressed)}}});this.viewSwitch=Ext.create('Ext.button.Button',{iconCls:'viewInterfaceIcon',text:desLang.layout,showType:'loaded',enableToggle:!0,pressed:!0,toggleGroup:'viewTypeGroup',scope:this,toggleHandler:function(btn,status){if(status){this.contentContainer.getLayout().setActiveItem(0);if(this.needRefresh){this.refreshCodeframe(!0)}}else{this.contentContainer.getLayout().setActiveItem(1)}}});this.codeSwitch=Ext.create('Ext.button.Button',{iconCls:'viewCodeIcon',text:desLang.code,showType:'loaded',scope:this,enableToggle:!0,pressed:!1,toggleGroup:'viewTypeGroup'});this.projectPathLabel=Ext.create('Ext.toolbar.TextItem',{});this.dockedItems=[{xtype:'toolbar',dock:'left',defaults:{showType:'loaded',iconCls:'add16',textAlign:'left',scope:this,handler:this.addObject},items:[{text:desLang.container,iconCls:'containerIcon',tooltip:desLang.add+' '+desLang.container,oClass:'container'},{text:desLang.panel,iconCls:'panelIcon',tooltip:desLang.add+' '+desLang.panel,oClass:'panel'},{text:desLang.tabPanel,tooltip:desLang.add+' '+desLang.tabPanel,iconCls:'tabIcon',oClass:'tabpanel'},{text:desLang.grid,iconCls:'gridIcon',tooltip:desLang.add+' '+desLang.grid,oClass:'grid'},{text:desLang.toolbar,iconCls:'toolbarPanelIcon',tooltip:desLang.add+' '+desLang.toolbar,oClass:'',handler:!1,menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},defaults:{scope:this,handler:this.addObject},items:[{text:'Panel',iconCls:'toolbarPanelIcon',oClass:'Toolbar',showType:'loaded'},{text:'Separator',iconCls:'toolbarSeparatorIcon',oClass:'Toolbar_Separator',showType:'loaded'},{text:'Spacer',iconCls:'toolbarSpacerIcon',oClass:'Toolbar_Spacer',showType:'loaded'},{text:'Fill',iconCls:'toolbarFillIcon',tooltip:desLang.tbFillDescription,oClass:'Toolbar_Fill',showType:'loaded'},{text:'Text Item',iconCls:'toolbarTextitemIcon',oClass:'Toolbar_Textitem',showType:'loaded'},{text:desLang.pagingToolbar,iconCls:'pagingIcon',tooltip:desLang.add+' '+desLang.pagingToolbar,oClass:'Toolbar_Paging',showType:'loaded'}]})},{text:desLang.menu,iconCls:'menuIcon',tooltip:desLang.add+' '+desLang.menu,oClass:'',handler:!1,menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},defaults:{scope:this,handler:this.addObject},items:[{text:'Item',iconCls:'toolbarTextitemIcon',oClass:'Menu_Item',showType:'loaded'},{text:'Separator',iconCls:'menuSeparatorIcon',oClass:'Menu_Separator',showType:'loaded'},{text:'Check Item',iconCls:'checkboxIcon',oClass:'Menu_Checkitem',showType:'loaded'},{text:'Date Picker',iconCls:'dateIcon',oClass:'Menu_Datepicker',showType:'loaded'},{text:'Color Picker',iconCls:'colorPickerIcon',oClass:'Menu_Colorpicker',showType:'loaded'}]})},{text:desLang.form,iconCls:'formIcon',oClass:'',handler:!1,menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},defaults:{scope:this,handler:this.addObject},items:[{text:desLang.formPanel,iconCls:'formIcon',tooltip:desLang.add+' '+desLang.form,oClass:'form',showType:'loaded'},{text:'Text',iconCls:'textFieldIcon',oClass:'Form_Field_Text',showType:'loaded'},{text:'Number',iconCls:'textFieldIcon',oClass:'Form_Field_Number',showType:'loaded'},{text:'Hidden',iconCls:'hiddenFieldIcon',showType:'loaded',oClass:'Form_Field_Hidden'},{text:'Checkbox',iconCls:'checkboxIcon',oClass:'Form_Field_Checkbox',showType:'loaded'},{text:'Textarea',iconCls:'textareaIcon',tooltip:desLang.tbFillDescription,oClass:'Form_Field_Textarea',showType:'loaded'},{text:'Htmleditor',iconCls:'htmlEditorIcon',oClass:'Form_Field_Htmleditor',showType:'loaded'},{text:'File',iconCls:'fileIcon',oClass:'Form_Field_File',showType:'loaded'},{text:'Radio',iconCls:'radioIcon',oClass:'Form_Field_Radio',showType:'loaded'},{text:'Time',iconCls:'clockIcon',oClass:'Form_Field_Time',showType:'loaded'},{text:'Date',iconCls:'dateIcon',oClass:'Form_Field_Date',showType:'loaded'},{text:'Fieldset',iconCls:'fieldsetIcon',oClass:'Form_Fieldset',showType:'loaded'},{text:'Display Field',iconCls:'displayfieldIcon',oClass:'Form_Field_Display',showType:'loaded'},{text:'Field Container',iconCls:'fieldContainerIcon',oClass:'Form_Fieldcontainer',showType:'loaded'},{text:'Checkbox group',iconCls:'checkboxGroupIcon',oClass:'Form_Checkboxgroup',showType:'loaded'},{text:'Radio group',iconCls:'radioGroupIcon',oClass:'Form_Radiogroup',showType:'loaded'},{text:'Combobox',iconCls:'comboboxFieldIcon',showType:'loaded',oClass:'Form_Field_Combobox'},{text:'Tag Field',iconCls:'tagIcon',showType:'loaded',oClass:'Form_Field_Tag'}]})},{text:desLang.buttons,iconCls:'buttonIcon',tooltip:desLang.add+' '+desLang.buttons,oClass:'',handler:!1,menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},defaults:{scope:this,handler:this.addObject},items:[{text:desLang.button,iconCls:'buttonIcon',tooltip:desLang.add+' '+desLang.button,oClass:'Button',showType:'loaded'},{text:desLang.splitButton,iconCls:'buttonSplitIcon',tooltip:desLang.add+' '+desLang.splitButton,oClass:'Button_Split',showType:'loaded'},{text:desLang.buttonGroup,iconCls:'buttonGroupIcon',tooltip:desLang.add+' '+desLang.buttonGroup,oClass:'Buttongroup',showType:'loaded'}]})},{text:desLang.tree,iconCls:'treeIcon',tooltip:desLang.add+' '+desLang.tree,oClass:'tree'},{text:'Image',iconCls:'imageIcon',tooltip:desLang.add+' '+desLang.image,oClass:'image'},{text:desLang.view,iconCls:'viewViewIcon',tooltip:desLang.add+' '+desLang.view,oClass:'view'},'-',{text:desLang.window,iconCls:'windowIcon',tooltip:desLang.add+' '+desLang.window,oClass:'window'},'-',{text:desLang.store,iconCls:'storeIcon',tooltip:desLang.add+' '+desLang.store,oClass:'Data_Store'},{text:desLang.treeStore,iconCls:'storeIcon',tooltip:desLang.add+' '+desLang.treeStore,oClass:'Data_Store_Tree'},{text:desLang.bufferedStore,iconCls:'storeIcon',tooltip:desLang.add+' '+desLang.bufferedStore,oClass:'Data_Store_Buffered'},'-',{text:desLang.model,iconCls:'modelIcon',tooltip:desLang.add+' '+desLang.model,oClass:'Model'},'-',{text:desLang.components,iconCls:'panelIcon',oClass:'',showType:'loaded',handler:!1,menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},defaults:{scope:this,handler:this.addObject},items:[{text:'CRUD Window',iconCls:'objectWindowIcon',oClass:'Component_Window_System_Crud',showType:'loaded'},{text:'CRUD VC Window',iconCls:'objectWindowIcon',oClass:'Component_Window_System_Crud_Vc',showType:'loaded'},{text:desLang.field,showType:'loaded',iconCls:'textFieldIcon',menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},defaults:{scope:this,handler:this.addObject},items:[{text:desLang.searchField,iconCls:'textFieldIcon',oClass:'Component_Field_System_Searchfield',showType:'loaded'},{text:desLang.dictionaryField,iconCls:'comboboxFieldIcon',oClass:'Component_Field_System_Dictionary',showType:'loaded'},{text:desLang.mediaHtmlField,iconCls:'textMediaFieldIcon',oClass:'Component_Field_System_Medialibhtml',showType:'loaded'},{text:desLang.mediaItemField,iconCls:'resourceFieldIcon',oClass:'Component_Field_System_Medialibitem',showType:'loaded'},{text:desLang.relatedItemsGrid,iconCls:'gridIcon',oClass:'Component_Field_System_Related',showType:'loaded'},{text:desLang.objectLinkField,iconCls:'olinkIcon',oClass:'Component_Field_System_Objectlink',showType:'loaded'},{text:desLang.objectsListPanel,iconCls:'gridIcon',oClass:'Component_Field_System_Objectslist',showType:'loaded'}]})},{text:desLang.storeFilter,handler:this.addObject,oClass:'Component_Filter',showType:'loaded'}]})},{text:desLang.addInstance,iconCls:'containerIcon',oClass:'',showType:'loaded',tooltip:desLang.addInstanceTip,handler:this.addInstance,scope:this},'-',{text:desLang.templates,iconCls:'containerIcon',oClass:'',showType:'loaded',tooltip:desLang.componentTemplates,scope:this,handler:!1,menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},defaults:{scope:this,handler:this.addTemplateObject},items:componentTemplates})}]},{xtype:'toolbar',dock:'top',items:[{text:desLang.layout,showType:'all',menu:Ext.create('Ext.menu.Menu',{style:{overflow:'visible'},items:[{text:desLang.newInterface,iconCls:'newIcon',scope:this,handler:this.createProject,showType:'empty'},{text:desLang.load,iconCls:'openIcon',scope:this,handler:this.selectProject,showType:'empty'},{text:desLang.save,iconCls:'saveIcon',handler:this.saveProject,scope:this,showType:'loaded'},{text:desLang.close,iconCls:'exitIcon',scope:this,handler:this.closeProject,showType:'loaded'}]})},{tooltip:desLang.save,iconCls:'saveIcon',handler:this.saveProject,scope:this,showType:'loaded'},'-',{tooltip:desLang.refreshView,iconCls:'refreshIcon',showType:'loaded',scope:this,handler:function(){this.onChange(!0)}},'-',this.autoRefreshSwitch,'-',desLang.viewMode+' :',this.viewSwitch,' / ',this.codeSwitch,{iconCls:'jsIcon',showType:'loaded',tooltip:desLang.showProjectCode,scope:this,handler:this.showProjectCode},{iconCls:'debugIcon',showType:'loaded',tooltip:desLang.showProjectContent,href:app.root+'debugger'},'-',{iconCls:'storeIcon',text:desLang.dbConnections,handler:function(){Ext.create('app.orm.connections.Window',{dbConfigs:dbConfigsList,controllerUrl:app.createUrl([app.admin,'orm','connections',''])}).show()},showType:'all'},{iconCls:'configureIcon',text:desLang.projectConfig,showType:'loaded',handler:function(){Ext.create('designer.configWindow',{controllerUrl:designer.controllerUrl,listeners:{dataSaved:{fn:this.onChange,scope:this}}}).show()}},'-',{text:desLang.relatedProjectItems,showType:'loaded',handler:this.showRelatedProjectItems,scope:this},'-',{text:desLang.backToAdminInterface,showType:'all',href:app.createUrl([app.admin]),hrefTarget:'_self'},'-','->',this.projectPathLabel]}]},initFrame:function(){var contentEl=this.centerPanel.body;this.activeFrame=contentEl.appendChild({tag:'iframe',cls:'viewFrame',id:'viewFrame1'});this.activeFrame.addListener('load',function(){contentEl.unmask()},this)},clearFrame:function(){this.activeFrame.dom.src=''},onChange:function(force){this.loadInterface(force)},loadInterface:function(force){this.projectItems.loadInfo();this.refreshCodeframe(force)},createProject:function(){Ext.create('app.filesystemWindow',{title:desLang.createProject,controllerUrl:app.createUrl([designer.controllerUrl,'fs','']),viewMode:'create',listeners:{fileCreated:{fn:this.loadProject,scope:this}}}).show()},selectProject:function(){Ext.create('app.filesystemWindow',{title:desLang.selectProject,viewMode:'select',controllerUrl:app.createUrl([designer.controllerUrl,'fs','']),listeners:{fileSelected:{fn:this.loadProject,scope:this}}}).show()},loadProject:function(name){var me=this;me.getEl().mask(appLang.LOADING);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'project','load']),method:'post',params:{file:name},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.checkIsLoaded()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
me.getEl().unmask()},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);me.getEl().unmask()}})},checkIsLoaded:function(){Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'project','checkloaded']),method:'post',scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.prepareInterface(!0);this.onChange();this.projectPathLabel.setText(response.data.file)}else{this.projectPathLabel.setText('');this.prepareInterface(!1)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},saveProject:function(callback){this.codeEditor.saveCode();this.preCodeEditor.saveCode();Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'project','save']),method:'post',success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){designer.msg(appLang.MESSAGE,desLang.msg_projectSaved);if(typeof callback=='function'){callback()}}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},closeProject:function(){var me=this;Ext.Msg.confirm(appLang.CONFIRMATION,appLang.MSG_SAVE_BEFORE_CLOSE,function(btn){if(btn=='yes'){var callbackFunc=function(){me.prepareInterface(!1);me.clearSession()};me.saveProject(callbackFunc)}else{me.clearSession();me.prepareInterface(!1)}},this)},prepareInterface:function(asLoaded){Ext.each(this.getDockedItems('toolbar'),function(toolbar){Ext.each(toolbar.query('button , menuitem'),function(item,index){if(item.showType==='all'){return}
if(asLoaded){(item.showType=='loaded')?item.enable():item.disable()}else{(item.showType=='loaded')?item.disable():item.enable()}},this)},this);if(asLoaded){this.rightPanel.enable();this.centerPanel.enable();this.codeEditor.enable();this.preCodeEditor.enable();this.eventsEditor.enable();this.methodsEditor.enable();this.eventsEditor.getStore().load();this.methodsEditor.getStore().load();this.codeEditor.loadCode();this.preCodeEditor.loadCode()}else{this.codeEditor.disable();this.codeEditor.setValue('');this.preCodeEditor.disable();this.preCodeEditor.setValue('');this.eventsEditor.disable();this.methodsEditor.disable();this.projectItems.clearData();this.propertiesPanel.removeAll();this.activePropertyPanel=null;this.projectPathLabel.setText('');this.rightPanel.disable();this.centerPanel.disable();this.clearFrame()}},clearSession:function(){Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'project','close']),method:'post',failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},addObject:function(btn){var oClass=btn.oClass;var me=this;var parent=0;if(!oClass.length){return}
Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterObjectName,function(btn,text){if(btn!='ok'){return}
var selection=me.projectItems.componentsTree.treePanel.getSelectionModel();if(selection.hasSelection()){selected=selection.getSelection()[0];if(!selected.leaf){parent=selected.get('id')}}
Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'project','addobject']),method:'post',params:{'name':text,'class':oClass,'parent':parent},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.onChange();designer.msg(desLang.success,desLang.objectAdded)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})})},addInstance:function(btn){var parent='';var selection=this.projectItems.componentsTree.treePanel.getSelectionModel();if(selection.hasSelection()){var selected=selection.getSelection()[0];if(!selected.leaf){parent=selected.get('id')}}
Ext.create('designer.addInstanceWindow',{controllerUrl:app.createUrl([designer.controllerUrl,'project','']),parentObject:parent,listeners:{objectAdded:{fn:function(name){designer.msg(desLang.success,desLang.objectAdded);this.onChange()},scope:this}}}).show()},addTemplateObject:function(btn){var me=this;var parent=0;Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterObjectName,function(resultBtn,text){if(resultBtn!='ok'){return}
var selection=me.projectItems.componentsTree.treePanel.getSelectionModel();if(selection.hasSelection()){selected=selection.getSelection()[0];if(!selected.leaf){parent=selected.get('id')}}
Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'project','addtemplate']),method:'post',params:{'name':text,'adapter':btn.adapter,'parent':parent},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.onChange();designer.msg(desLang.success,desLang.objectAdded)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})})},showProperties:function(objectName,objectClass,objectTitle,isInstance){var oldSearch=!1;var oldEvent=!1;var oldMethod=!1;if(this.activePropertyPanel){oldSearch=this.activePropertyPanel.getSearchText();oldEvent=this.activePropertyPanel.getEventsSearchText();oldMethod=this.activePropertyPanel.getMethodsSearchText()}
this.propertiesPanel.removeAll(!0,!0);if(this.activePropertyPanel){this.activePropertyPanel.clearListeners();this.activePropertyPanel.destroy()}
var panelClass=null;if(objectClass==='Designer_Project_Container'){return}
if(!isInstance){switch(objectClass){case 'Panel':panelClass='designer.properties.Panel';break;case 'Grid':panelClass='designer.properties.Grid';break;case 'Store':case 'Data_Store':panelClass='designer.properties.Store';break;case 'Data_Store_Tree':panelClass='designer.properties.TreeStore';break;case 'Data_Store_Buffered':panelClass='designer.properties.Store';break;case 'Model':panelClass='designer.properties.Model';break;case 'Component_Window_System_Crud':case 'Component_Window_System_Crud_Vc':panelClass='designer.properties.CrudWindow';break;case 'Window':panelClass='designer.properties.Window';break;case 'Form':panelClass='designer.properties.Form';break;case 'Component_Filter':panelClass='designer.properties.FilterComponent';break;case 'Component_Field_System_Searchfield':panelClass='designer.properties.Search';break;case 'Component_Field_System_Medialibitem':panelClass='designer.properties.MediaItem';break;default:if(objectClass.indexOf('Field_',0)!==-1||objectClass==='Form_Checkboxgroup'){panelClass='designer.properties.Field'}else{panelClass='designer.properties.Panel'}
break}}else{panelClass='designer.properties.Panel'}
var me=this;this.propertiesPanel.suspendEvents(!0);this.propertiesPanel.setTitle('<span style="color:blue">'+objectTitle+' </span> '+desLang.properties);this.activePropertyPanel=Ext.create(panelClass,{controllerUrl:app.createUrl([designer.controllerUrl,'properties','']),eventsControllerUrl:app.createUrl([designer.controllerUrl,'events','']),methodsControllerUrl:app.createUrl([designer.controllerUrl,'methods','']),showMethods:!0,objectName:objectName,application:me,listeners:{'dataSaved':{fn:function(field){me.refreshCodeframe();if(!Ext.isEmpty(field)){if(field==='isExtended'){this.methodsEditor.getStore().load()}}},scope:me},'objectsUpdated':{fn:me.onChange,scope:me},'eventsUpdated':{fn:function(){me.eventsEditor.getStore().load();me.onChange()},scope:me},'methodsUpdated':{fn:function(){me.methodsEditor.getStore().load();me.onChange()},scope:me},'afterLoad':{fn:function(){if(oldSearch){this.activePropertyPanel.setSearchText(oldSearch);oldSearch=!1}
if(oldEvent){this.activePropertyPanel.setEventsSearchText(oldEvent);oldEvent=!1}
if(oldMethod){this.activePropertyPanel.setMethodsSearchText(oldMethod);oldMethod=!1}},scope:me}}});this.propertiesPanel.add(this.activePropertyPanel);this.propertiesPanel.resumeEvents()},refreshCodeframe:function(force){var forceLayout=force||!1;var contentEl=this.centerPanel.body;if(!this.viewSwitch.pressed){this.needRefresh=!0;return}
if(forceLayout===!0||this.autoRefreshSwitch.pressed||this.frameFirstLoad){var dt=new Date();var newUrl=app.createUrl([designer.controllerUrl,'viewframe','index',dt.getTime()]);contentEl.mask(desLang.loading);this.activeFrame.dom.src=newUrl;this.frameFirstLoad=!1}},storesStore:function(){return this.projectItems.panelsTab.getStore()},getStoreSelector:function(){var store=this.projectItems.createStore('stores');store.proxy.setExtraParam('instances',!0);return store},createStoresList:function(includeInstances){var store=this.projectItems.createStore('store_selection');store.proxy.setExtraParam('stores',!includeInstances);store.proxy.setExtraParam('instances',includeInstances);return store},getMenuStore:function(){return this.projectItems.createStore('menu')},getModelsStore:function(){return this.projectItems.modelsStore},sendCommand:function(command){var view=this.activeFrame.dom.contentWindow;view.postMessage(command,window.location.origin)},showRelatedProjectItems:function(){var dt=new Date();Ext.create('designer.relatedProjectItemsWindow',{listUrl:app.createUrl([designer.controllerUrl,'objects','relatedprojectlist',dt.getTime()])}).show()},switchView:function(index){switch(index){case 0:this.viewSwitch.toggle(!0);break;case 1:this.codeSwitch.toggle(!0);break}},showProjectCode:function(){Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'code','projectcode']),method:'post',scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
var editor=Ext.create('designer.codeEditor',{sourceCode:response.data,readOnly:!0});Ext.create('Ext.Window',{title:desLang.sourceCode,layout:'fit',width:600,height:500,modal:!0,maximizable:!0,items:[editor]}).show()},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})}});Ext.define('designer.urlWindow',{extend:'Ext.Window',fileTree:null,actionsGrid:null,layout:'border',onlyController:!1,controllerUrl:'',initComponent:function(){this.title=desLang.selectController;this.fileTree=Ext.create('app.FilesystemTree',{region:'center',controllerUrl:app.createUrl([designer.controllerUrl,'url','']),split:!0});this.actionsGrid=Ext.create('Ext.grid.Panel',{region:'east',width:300,columnLines:!0,split:!0,store:Ext.create('Ext.data.Store',{extraParams:{controller:''},fields:[{name:'name',type:'string'},{name:'comment',type:'string'},{name:'code',type:'string'},{name:'url',type:'string'}],proxy:{url:this.controllerUrl,type:'ajax',reader:{type:'json',idProperty:'name',rootProperty:'data'}},autoLoad:!1}),columns:[{text:desLang.action,dataIndex:'name',width:100},{text:desLang.description,flex:1,dataIndex:'comment',renderer:app.linesRenderer}]});var me=this;this.buttons=[{text:desLang.select,scope:me,handler:me.onSelect},{text:desLang.cancel,scope:me,handler:me.close}];this.items=[this.fileTree,this.actionsGrid];this.callParent();if(this.onlyController){return}
this.fileTree.getSelectionModel().on('selectionchange',function(sm,records,options){var store=this.actionsGrid.getStore();if(!sm.hasSelection()){return}
store.removeAll();var rec=records[0];if(rec.get('leaf')){store.proxy.setExtraParam('controller',rec.get('id'));store.load()}},this)},onSelect:function(){if(this.onlyController){if(!this.fileTree.getSelectionModel().hasSelection()){return}
var selected=this.fileTree.getSelectionModel().getSelection()[0];this.fireEvent('select',selected.get('url'));this.close();return}
var sm=this.actionsGrid.getSelectionModel();if(!sm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,desLang.selectAction);return}
var selection=sm.getSelection()[0];this.fireEvent('select',selection.get('url'));this.close()}});Ext.define('designer.urlField',{extend:'Ext.form.field.Text',constructor:function(config){var me=this;config=Ext.apply({extraParams:{},triggers:{select:{hideOnReadOnly:!0,cls:'urlTriggerIcon',width:25,handler:function(field,trigger,e){me.showSelectWindow();e.stopEvent()},scope:me}}},config||{});this.callParent(arguments)},showSelectWindow:function(){var me=this;var win=Ext.create('designer.urlWindow',{width:600,height:400,modal:!0,onlyController:this.onlyController,controllerUrl:this.controllerUrl,listeners:{scope:me,select:function(url){me.setValue(url);me.fireEvent('select',url)}}});Ext.defer(function(){win.show().toFront()},50)}});Ext.define('designer.iconField',{alias:'widget.urlfield',controllerUrl:'',extend:'Ext.form.field.Text',updateEl:!0,constructor:function(config){var me=this;config=Ext.apply({extraParams:{},triggers:{select:{hideOnReadOnly:!0,cls:'urlTriggerIcon',width:25,handler:function(){me.showSelectWindow()},scope:me}}},config||{});this.callParent(arguments)},showSelectWindow:function(){var me=this;var win=Ext.create('designer.iconSelectorWindow',{width:600,height:400,controllerUrl:this.controllerUrl,title:desLang.images,listeners:{scope:me,select:function(url){me.setValue(url);me.fireEvent('select',url)}}});Ext.defer(function(){win.show().toFront()},50)}});Ext.define('designer.ormSelectorWindow',{extend:'Ext.Window',title:desLang.importOrm,width:700,height:500,objectsGrid:null,fieldsGrid:null,layout:'border',initComponent:function(){var store=Ext.create('Ext.data.Store',{fields:[{name:'name',type:'string'},{name:'title',type:'string'}],proxy:{url:app.createUrl([designer.controllerUrl,'orm','list','']),type:'ajax',reader:{type:'json',idProperty:'name',rootProperty:'data'}},autoLoad:!0,sorters:[{property:'name',direction:'ASC'}]});this.objectsGrid=Ext.create('Ext.grid.Panel',{split:!0,title:desLang.objects,region:'center',columnLines:!0,tbar:['->',Ext.create('SearchPanel',{fieldNames:['name','title'],store:store,local:!0})],store:store,columns:[{text:desLang.name,dataIndex:'name',width:100},{text:desLang.title,flex:1,dataIndex:'title'}]});var sm=Ext.create('Ext.selection.CheckboxModel');this.fieldsGrid=Ext.create('Ext.grid.Panel',{split:!0,title:desLang.fields,region:'east',selModel:sm,width:350,columnLines:!0,store:Ext.create('Ext.data.Store',{fields:[{name:'name',type:'string'},{name:'title',type:'string'},{name:'type',type:'string'}],proxy:{url:app.createUrl([designer.controllerUrl,'orm','fields','']),type:'ajax',extraParams:{object:''},reader:{type:'json',idProperty:'name',rootProperty:'data'}},autoLoad:!1,sorters:[{property:'name',direction:'ASC'}]}),columns:[{text:desLang.name,dataIndex:'name',width:100},{text:desLang.title,flex:1,dataIndex:'title'},{text:desLang.type,flex:1,dataIndex:'type'}]});this.objectsGrid.getSelectionModel().on('selectionchange',function(sm){this.fieldsGrid.getStore().removeAll();if(sm.hasSelection()){this.fieldsGrid.getStore().proxy.setExtraParam('object',sm.getSelection()[0].get('name'));this.fieldsGrid.getStore().load()}},this);this.buttons=[{text:desLang.select,scope:this,handler:this.onSelect},{text:desLang.cancel,scope:this,handler:this.close}];this.items=[this.objectsGrid,this.fieldsGrid];this.callParent();this.on('show',function(){app.checkSize(this)},this)},onSelect:function(){var oSm=this.objectsGrid.getSelectionModel();var fSm=this.fieldsGrid.getSelectionModel();if(!oSm.hasSelection()||!fSm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,desLang.selectObjectAndFields);return}
var selection=fSm.getSelection();var names=[];Ext.each(selection,function(item,index){names.push(item.get('name'))},this);this.fireEvent('select',oSm.getSelection()[0].get('name'),names);this.close()}});Ext.define('designer.iconModel',{extend:'Ext.data.Model',fields:[{name:'name'},{name:'url'},{name:'path'}]});Ext.define('designer.iconSelectorWindow',{extend:'Ext.Window',layout:'border',dataTree:null,dataView:null,viewPanel:null,controllerUrl:'',listAction:'imgdirlist',imagesAction:'imglist',width:500,height:300,modal:!0,iconWidth:16,iconHeight:16,initComponent:function(){this.dataTree=Ext.create('app.FilesystemTree',{controllerUrl:this.controllerUrl,listAction:this.listAction,region:'west',minWidth:250,width:250,collapsible:!0,listeners:{'select':{fn:function(RowModel,record,index,eOpts){var store=this.dataView.getStore();store.proxy.setExtraParam('dir',record.get('id'));store.load()},scope:this}}});this.dataView=Ext.create('Ext.view.View',{store:Ext.create('Ext.data.Store',{model:'designer.iconModel',proxy:{type:'ajax',url:this.controllerUrl+this.imagesAction,reader:{type:'json',rootProperty:'data'},autoLoad:!1}}),tpl:['<tpl for=".">','<div class="thumb-wrap" id="{name}">','<div class="thumb" align="center"><img src="{url}" title="{name}" width="'+this.iconWidth+'" height="'+this.iconHeight+'"></div>','<span class="x-editable">{shortName}</span></div>','</tpl>','<div class="x-clear"></div>'],multiSelect:!1,height:310,trackOver:!0,cls:'images-view',overItemCls:'x-item-over',itemSelector:'div.thumb-wrap',emptyText:desLang.noImagesToDisplay,prepareData:function(data){Ext.apply(data,{shortName:Ext.util.Format.ellipsis(data.name,15)});return data}});this.viewPanel=Ext.create('Ext.Panel',{region:'center',items:[this.dataView],frame:!1,bodyCls:'formBody',scrollable:!0});this.items=[this.dataTree,this.viewPanel];this.buttons=[{text:desLang.select,scope:this,handler:this.onSelect},{text:desLang.cancel,scope:this,handler:this.close}]
this.callParent()},onSelect:function(){var sm=this.dataView.getSelectionModel();if(!sm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,desLang.selectIcon);return}
this.fireEvent('select',sm.getLastSelected().get('path'));this.close()}});Ext.define('designer.defaultsModel',{extend:'Ext.data.Model',fields:[{name:'key',type:'string'},{name:'value',type:'string'}]});Ext.define('designer.defaultsWindow',{extend:'Ext.Window',title:'defaults',dataGrid:null,dataStore:null,cellEditing:null,width:300,height:400,modal:!0,closeAction:'destroy',initialData:null,layout:'fit',initComponent:function(){this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.dataStore=Ext.create('Ext.data.Store',{model:'designer.defaultsModel'});this.dataStore.loadData(this.initialData);this.tbar=[{iconCls:'plusIcon',tooltip:desLang.add,handler:function(){var r=Ext.create('designer.defaultsModel',{key:'',value:''});this.dataStore.insert(0,r);this.cellEditing.startEditByPosition({row:0,column:0})},scope:this}];this.dataGrid=Ext.create('Ext.grid.Panel',{store:this.dataStore,scrollable:!0,frame:!1,loadMask:!0,columnLines:!0,plugins:[this.cellEditing],columns:[{text:desLang.key,dataIndex:'key',flex:1,editor:{xtype:'textfield'}},{text:desLang.value,dataIndex:'value',flex:1,editor:{xtype:'textfield'}},{xtype:'actioncolumn',width:25,align:'center',sortable:!1,menuDisabled:!0,items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();store.remove(store.getAt(row))}}]}]});this.items=[this.dataGrid];this.buttons=[{text:desLang.save,scope:this,handler:this.saveData},{text:desLang.cancel,scope:this,handler:this.close}];this.callParent()},saveData:function(){var s='';var result={};this.dataStore.commitChanges();this.dataStore.each(function(item){if(item.get('key').length){if(Ext.isNumeric(item.get('value'))){result[item.get('key')]=parseFloat(item.get('value'))}else{var val=item.get('value');switch(val){case 'true':val=!0;break;case 'false':val=!1;break;case 'null':val=null}
result[item.get('key')]=val}}});this.fireEvent('dataChanged',Ext.JSON.encode(result));this.close()}});Ext.define('designer.paramsWindow',{extend:'designer.defaultsWindow',saveData:function(){var s='';var items={};this.dataStore.commitChanges();this.dataStore.each(function(item){if(item.get('key').length){items[item.get('key')]=item.get('value')}});this.fireEvent('dataChanged',Ext.JSON.encode(items));this.close()}});Ext.define('designer.addInstanceWindow',{extend:'Ext.Window',modal:!0,layout:'fit',width:300,height:130,controllerUrl:'',parentObject:'',initComponent:function(){this.title=desLang.addInstance;this.objectsStore=Ext.create('Ext.data.Store',{autoLoad:!0,fields:[{name:"name",type:"string"}],proxy:{url:this.controllerUrl+'caninstantiate',reader:{idProperty:"name",rootProperty:"data",type:"json"},type:"ajax"}});this.dataForm=Ext.create('Ext.form.Panel',{bodyPadding:5,bodyCls:'formBody',fieldDefaults:{anchor:'100%',labelWidth:70,labelAlign:'right'},items:[{name:'name',fieldLabel:desLang.name,xtype:'textfield',vType:'alphanum',allowBlank:!1},{fieldLabel:desLang.instanceOf,xtype:'combobox',forceSelection:!0,allowBlank:!1,displayField:'name',valueField:'name',store:this.objectsStore,queryMode:'local',name:'instance'}]});this.buttons=[{text:desLang.add,handler:this.addObject,scope:this},{text:desLang.cancel,handler:this.close,scope:this}];this.items=[this.dataForm];this.callParent()},addObject:function(){var me=this;this.dataForm.getForm().submit({clientValidation:!0,waitMsg:appLang.SAVING,method:'post',url:this.controllerUrl+'addinstance',params:{'parent':this.parentObject},success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}else{me.fireEvent('objectAdded',me.dataForm.getForm().findField('name'));me.close()}},failure:app.formFailure})}});Ext.define('designer.configWindow',{extend:'Ext.Window',controllerUrl:'',title:desLang.projectConfig,dataForm:null,layout:'fit',modal:!0,width:500,height:600,includesGrid:null,langsGrid:null,resizable:!1,langsCombo:null,initComponent:function(){this.includesGrid=Ext.create('Ext.grid.Panel',{hideLabel:!0,height:230,title:desLang.includedFiles,tbar:[{iconCls:'plusIcon',text:desLang.addFile,handler:this.showAddFile,scope:this},{iconCls:'plusIcon',text:desLang.addProjectFile,handler:this.showAddProject,scope:this}],store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',reader:{type:'json'}},fields:[{name:'file',type:'string'}],autoLoad:!1}),columns:[{text:desLang.name,dataIndex:'file',flex:1},app.sortColumn()]});this.langsCombo=Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',allowBlank:!1,queryMode:'local',store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',reader:{type:'json'}},fields:[{name:'name',type:'string'}],autoLoad:!1}),valueField:'name',displayField:'name',allowBlank:!0});this.langsGrid=Ext.create('Ext.grid.Panel',{hideLabel:!0,height:240,title:desLang.includedLangs,tbar:[this.langsCombo,{iconCls:'plusIcon',text:desLang.addLangFile,handler:this.addLang,scope:this}],store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',reader:{type:'json'}},fields:[{name:'name',type:'string'}],autoLoad:!1}),columns:[{text:desLang.name,dataIndex:'name',flex:1},app.sortColumn()]});this.dataForm=Ext.create('Ext.form.Panel',{bodyCls:'formBody',bodyPadding:5,fieldDefaults:{labelAlign:'left',anchor:'100%',labelWidth:180},defaults:{xtype:'textfield'},items:[{name:'namespace',fieldLabel:desLang.projectNamespace},{name:'runnamespace',fieldLabel:desLang.projectRunNamespace},this.includesGrid,this.langsGrid]});this.items=[this.dataForm];this.buttons=[{text:desLang.save,scope:this,handler:this.saveAction},{text:desLang.close,scope:this,handler:this.close},];this.callParent(arguments);this.dataForm.load({url:this.controllerUrl+'/project/loadconfig',scope:this,success:function(form,action){if(action.result.success){this.includesGrid.getStore().loadData(action.result.data.files);this.langsGrid.getStore().loadData(action.result.data.langs);this.langsCombo.getStore().loadData(action.result.data.langsList)}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg);this.close()}},failure:function(form,action){Ext.Msg.alert(appLang.MESSAGE,desLang.cantLoad);this.close()}})},showAddFile:function(){var win=Ext.create('app.filesystemWindow',{controllerUrl:this.controllerUrl+'/project/'});win.on('fileSelected',function(file){var store=this.includesGrid.getStore();store.insert(store.getCount(),{file:file})},this);win.show()},showAddProject:function(){var win=Ext.create('app.filesystemWindow',{controllerUrl:this.controllerUrl+'/project/',listAction:'projectlist'});win.on('fileSelected',function(file){var store=this.includesGrid.getStore();store.insert(store.getCount(),{file:file})},this);win.show()},addLang:function(){var lang=this.langsCombo.getValue();var langStore=this.langsGrid.getStore();var index=langStore.findExact('name',lang);if(index==-1){langStore.insert(langStore.getCount(),{name:lang})}},saveAction:function(){var me=this;var files=[];var langs=[];this.includesGrid.getStore().each(function(record){files.push(record.get('file'))});this.langsGrid.getStore().each(function(record){langs.push(record.get('name'))});this.dataForm.getForm().submit({clientValidation:!0,waitMsg:appLang.SAVING,method:'post',scope:this,params:{'files[]':files,'langs[]':langs},url:this.controllerUrl+'/project/setconfig',success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}else{me.fireEvent('dataSaved');me.close()}},failure:app.formFailure})}});Ext.define('designer.configWindow',{extend:'Ext.Window',controllerUrl:'',title:desLang.projectConfig,dataForm:null,layout:'fit',modal:!0,width:500,height:600,includesGrid:null,langsGrid:null,resizable:!1,langsCombo:null,initComponent:function(){this.includesGrid=Ext.create('Ext.grid.Panel',{hideLabel:!0,height:230,title:desLang.includedFiles,tbar:[{iconCls:'plusIcon',text:desLang.addFile,handler:this.showAddFile,scope:this},{iconCls:'plusIcon',text:desLang.addProjectFile,handler:this.showAddProject,scope:this}],store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',reader:{type:'json'}},fields:[{name:'file',type:'string'}],autoLoad:!1}),columns:[{text:desLang.name,dataIndex:'file',flex:1},app.sortColumn()]});this.langsCombo=Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',allowBlank:!1,queryMode:'local',store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',reader:{type:'json'}},fields:[{name:'name',type:'string'}],autoLoad:!1}),valueField:'name',displayField:'name',allowBlank:!0});this.langsGrid=Ext.create('Ext.grid.Panel',{hideLabel:!0,height:240,title:desLang.includedLangs,tbar:[this.langsCombo,{iconCls:'plusIcon',text:desLang.addLangFile,handler:this.addLang,scope:this}],store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',reader:{type:'json'}},fields:[{name:'name',type:'string'}],autoLoad:!1}),columns:[{text:desLang.name,dataIndex:'name',flex:1},app.sortColumn()]});this.dataForm=Ext.create('Ext.form.Panel',{bodyCls:'formBody',bodyPadding:5,fieldDefaults:{labelAlign:'left',anchor:'100%',labelWidth:180},defaults:{xtype:'textfield'},items:[{name:'namespace',fieldLabel:desLang.projectNamespace},{name:'runnamespace',fieldLabel:desLang.projectRunNamespace},this.includesGrid,this.langsGrid]});this.items=[this.dataForm];this.buttons=[{text:desLang.save,scope:this,handler:this.saveAction},{text:desLang.close,scope:this,handler:this.close},];this.callParent(arguments);this.dataForm.load({url:this.controllerUrl+'/project/loadconfig',scope:this,success:function(form,action){if(action.result.success){this.includesGrid.getStore().loadData(action.result.data.files);this.langsGrid.getStore().loadData(action.result.data.langs);this.langsCombo.getStore().loadData(action.result.data.langsList)}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg);this.close()}},failure:function(form,action){Ext.Msg.alert(appLang.MESSAGE,desLang.cantLoad);this.close()}})},showAddFile:function(){var win=Ext.create('app.filesystemWindow',{controllerUrl:this.controllerUrl+'/project/'});win.on('fileSelected',function(file){var store=this.includesGrid.getStore();store.insert(store.getCount(),{file:file})},this);win.show()},showAddProject:function(){var win=Ext.create('app.filesystemWindow',{controllerUrl:this.controllerUrl+'/project/',listAction:'projectlist'});win.on('fileSelected',function(file){var store=this.includesGrid.getStore();store.insert(store.getCount(),{file:file})},this);win.show()},addLang:function(){var lang=this.langsCombo.getValue();var langStore=this.langsGrid.getStore();var index=langStore.findExact('name',lang);if(index==-1){langStore.insert(langStore.getCount(),{name:lang})}},saveAction:function(){var me=this;var files=[];var langs=[];this.includesGrid.getStore().each(function(record){files.push(record.get('file'))});this.langsGrid.getStore().each(function(record){langs.push(record.get('name'))});this.dataForm.getForm().submit({clientValidation:!0,waitMsg:appLang.SAVING,method:'post',scope:this,params:{'files[]':files,'langs[]':langs},url:this.controllerUrl+'/project/setconfig',success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}else{me.fireEvent('dataSaved');me.close()}},failure:app.formFailure})}});Ext.define('designer.codeEditor',{extend:'Ext.Panel',layout:'fit',autoRender:!0,scrollable:!1,codeMirror:null,codeMirrorInit:!1,styleHtmlContent:!0,editorId:null,sourceCode:'',readOnly:!1,controllerUrl:null,saveBtn:null,showSaveBtn:!0,btnUndo:null,btnRedo:null,collapsible:!1,extraKeys:!1,historyUndoState:{},headerText:'',footerText:'',initComponent:function(){this.saveBtn=Ext.create('Ext.Button',{tooltip:desLang.save,iconCls:'saveIcon',scope:this,disabled:!0,hidden:(this.readOnly||!this.showSaveBtn),handler:this.saveCode});this.btnUndo=Ext.create('Ext.Button',{tooltip:desLang.undo,iconCls:'undoIcon',scope:this,disabled:!0,handler:this.undoAction});this.btnRedo=Ext.create('Ext.Button',{tooltip:desLang.redo,iconCls:'redoIcon',scope:this,disabled:!0,handler:this.redoAction});this.tbar=[this.saveBtn,'-',this.btnUndo,this.btnRedo,'-',];this.editorId='CodeEditorCmp_'+this.id;this.html=this.headerText+'<textarea id="'+this.editorId+'" name="codeEditorCmp" style="width:100%;height:100%"></textarea>'+this.footerText;this.callParent();this.on('afterrender',this.initEditor,this)},initEditor:function(){if(this.codeMirrorInit){return}
var me=this;var keymap;var hline;if(this.extraKeys){keymap=this.extraKeys}else{keymap={"Ctrl-Space":function(cm){CodeMirror.simpleHint(cm,CodeMirror.javascriptHint)},"Ctrl-S":function(instance){me.saveCode()},"Ctrl-Z":function(instance){me.undoAction()},"Ctrl-Y":function(instance){me.redoAction()},"Shift-Ctrl-Z":function(instance){me.redoAction()}}}
var editor=CodeMirror.fromTextArea(document.getElementById(this.editorId),{styleActiveLine:!0,lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,readOnly:this.readOnly,extraKeys:keymap,highlightSelectionMatches:{showToken:/\w/}});editor.on('change',function(){me.onChange()});editor.setValue(this.sourceCode);this.codeMirror=editor;this.codeMirrorInit=!0;this.on('resize',this.syncEditor,this);this.on('show',this.syncEditor,this);this.updateLayout()},syncEditor:function(){var me=this;me.codeMirror.setSize('100%',me.getEl().getHeight()-62);me.codeMirror.refresh()},getSelectedRange:function(){return{from:this.codeMirror.getCursor(!0),to:this.codeMirror.getCursor(!1)}},formatSelection:function(){var range=this.getSelectedRange();if(range.from===range.to){return}
this.codeMirror.autoFormatRange(range.from,range.to)},getValue:function(){return this.codeMirror.getValue()},setValue:function(value){this.codeMirror.setValue(value)},saveCode:function(){this.getEl().mask(desLang.saving);Ext.Ajax.request({url:this.controllerUrl+'save',method:'post',scope:this,params:{code:this.codeMirror.getValue()},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg)}else{this.historyUndoState=this.codeMirror.historySize()['undo'];this.saveBtn.disable();designer.msg(appLang.MESSAGE,desLang.msg_scriptSaved)}
this.getEl().unmask()},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);this.getEl().unmask()}})},loadCode:function(){this.getEl().mask(desLang.loading);Ext.Ajax.request({url:this.controllerUrl+'load',method:'post',scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){this.disable();Ext.Msg.alert(appLang.MESSAGE,desLang.cantLoadActionJS+'.<br>'+response.msg)}else{this.codeMirror.setValue(response.data);this.syncEditor();this.historyUndoState=this.codeMirror.historySize()['undo'];this.onChange()}
this.getEl().unmask()},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);this.getEl().unmask()}})},onChange:function(){if(this.codeMirror!=null){var history=this.codeMirror.historySize();this.saveBtn.enable();if(history.undo>2){this.btnUndo.enable()}else{this.btnUndo.disable()}
if(history.redo){this.btnRedo.enable()}else{this.btnRedo.disable()}}},undoAction:function(){if(this.codeMirror!=null){this.codeMirror.undo()}},redoAction:function(){if(this.codeMirror!=null){this.codeMirror.redo()}}});Ext.define('designer.eventsModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'integer'},{name:'object',type:'string'},{name:'event',type:'string'},{name:'params',type:'string'},{name:'has_code',type:'boolean'},{name:'is_local',type:'boolean'}],idProperty:'event'});Ext.define('designer.eventsPanel',{extend:'Ext.grid.Panel',objectName:'',controllerUrl:'',columnLines:!0,searchField:null,addButton:null,canEditLocalEvents:!1,autoLoadData:!0,constructor:function(config){config=Ext.apply({extraParams:{}},config||{});this.callParent(arguments)},initComponent:function(){if(!this.controllerUrl.length){this.controllerUrl=app.createUrl([designer.controllerUrl,'events',''])}
this.extraParams.object=this.objectName;this.store=Ext.create('Ext.data.Store',{model:'designer.eventsModel',proxy:{type:'ajax',url:this.controllerUrl+'objectevents',reader:{type:'json',rootProperty:'data'},extraParams:this.extraParams,simpleSortMode:!0},remoteSort:!1,autoLoad:this.autoLoadData,sorters:[{property:'object',direction:'DESC'},{property:'event',direction:'DESC'}]});this.addButton=Ext.create('Ext.Button',{hidden:!this.canEditLocalEvents,scope:this,handler:this.addLocalEvent,iconCls:'addIcon',text:desLang.addEvent});this.searchField=Ext.create('SearchPanel',{store:this.store,local:!0,width:130,hideLabel:!0,fieldNames:['event']});this.tbar=[this.addButton,this.searchField];this.columns=[{xtype:'actioncolumn',width:40,items:[{width:20,tooltip:desLang.editAction,scope:this,iconCls:'editIcon',handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.editEvent(rec)}},{iconCls:'deleteIcon',tooltip:desLang.removeAction,handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.removeEvent(rec)},width:20,scope:this}]},{dataIndex:'event',text:desLang.event,flex:1},{dataIndex:'has_code',width:60,align:'center',text:desLang.hasCode,renderer:function(value,metaData,record){if(record.get('has_code')){return'<img src="'+app.wwwRoot+'i/system/yes.gif" data-qtip="'+appLang.YES+'" width="14" height="14">'}else{return''}}},{xtype:'actioncolumn',width:40,text:desLang.event,items:[{iconCls:'trashIcon',tooltip:desLang.removeEvent,handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);if(rec.get('is_local')){this.removeLocalEvent(rec)}},width:20,scope:this,isDisabled:function(view,rowIndex,colIndex,item,record){return!record.get('is_local')}}]}];this.on('celldblclick',function(table,td,cellIndex,record,tr,rowIndex,e,eOpts){this.editEvent(record)},this);this.callParent()},removeEvent:function(record){var params=Ext.clone(this.extraParams);params.event=record.get('event');Ext.Ajax.request({url:this.controllerUrl+'removeevent',method:'post',scope:this,params:params,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
designer.msg(appLang.MESSAGE,desLang.msg_listenerRemoved);record.set('has_code',!1);record.commit();this.fireEvent('eventsUpdated')},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},removeLocalEvent:function(record){var params=Ext.clone(this.extraParams);params.event=record.get('event');Ext.Ajax.request({url:this.controllerUrl+'removeeventdescription',method:'post',scope:this,params:params,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
designer.msg(appLang.MESSAGE,desLang.msg_eventDescriptionRemoved);this.getStore().remove(record);this.fireEvent('eventsUpdated')},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},setCanEditLocalEvents:function(value){if(value===this.canEditLocalEvents){return}
this.canEditLocalEvents=value;if(value){this.addButton.show()}else{this.addButton.hide()}
this.updateLayout()},editEvent:function(record){Ext.create('designer.eventsEditorWindow',{controllerUrl:this.controllerUrl,objectName:this.objectName,eventName:record.get('event'),paramsString:record.get('params'),extraParams:this.extraParams,modal:!0,listeners:{'codeSaved':{fn:function(){record.set('has_code',!0);record.commit();this.fireEvent('eventsUpdated')},scope:this},'eventUpdated':{fn:function(){this.getStore().load();this.fireEvent('eventsUpdated')},scope:this}}}).show()},addLocalEvent:function(){Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterEventName,function(btn,eventName){if(btn!=='ok'){return}
var params=Ext.clone(this.extraParams);params.event=eventName;var store=this.getStore();Ext.Ajax.request({url:this.controllerUrl+'addlocalevent',method:'post',scope:this,params:params,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
store.load({scope:this,callback:function(){var index=store.findExact('event',eventName);if(index!==-1){this.editEvent(store.getAt(index))}}});this.fireEvent('eventsUpdated')},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this)},getSearchText:function(){return this.searchField.getValue()},setSearchText:function(text){if(this.searchField){return this.searchField.getValue()}else{return''}},destroy:function(){this.addButton.destroy();this.store.destroy();this.searchField.destroy();this.callParent(arguments)}});Ext.define('designer.methodsEditor',{extend:'Ext.grid.Panel',scrollable:!0,controllerUrl:null,searchField:null,columnLines:!0,viewConfig:{stripeRows:!0,enableTextSelection:!0},initComponent:function(){if(!this.controllerUrl.length){this.controllerUrl=app.createUrl([designer.controllerUrl,'methods',''])}
this.store=Ext.create('Ext.data.Store',{fields:[{name:'enabled',type:'boolean'},{name:'object',type:'string'},{name:'method',type:'string'},{name:'params',type:'string'},{name:'has_code',type:'boolean'},{name:'description',type:'string'}],proxy:{type:'ajax',url:this.controllerUrl+'list',reader:{type:'json',rootProperty:'data',idProperty:'id'},simpleSortMode:!0},groupField:'object',remoteSort:!1,autoLoad:!1,sorters:[{property:'object',direction:'DESC'},{property:'method',direction:'DESC'}]});this.searchField=Ext.create('SearchPanel',{store:this.store,local:!0,fieldNames:['object','method']});this.tbar=[{iconCls:'refreshIcon',tooltip:desLang.refresh,scope:this,handler:function(){this.store.load()}},this.searchField];this.columns=[{xtype:'actioncolumn',width:20,items:[{iconCls:'editIcon',handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.editMethod(rec)},scope:this}]},{text:desLang.object,dataIndex:'object',width:150},{text:desLang.method,dataIndex:'method',width:150},{text:desLang.params,dataIndex:'params',flex:1},{text:desLang.description,dataIndex:'description',flex:1},{text:desLang.active,dataIndex:'enabled',align:'center',width:40,renderer:app.checkboxRenderer},{xtype:'actioncolumn',width:20,items:[{iconCls:'deleteIcon',handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.removeMethod(rec)},scope:this}]}];this.features=[Ext.create('Ext.grid.feature.Grouping',{groupHeaderTpl:'{name} ({rows.length})',startCollapsed:0,enableGroupingMenu:1,hideGroupedHeader:0})];this.on('itemdblclick',function(view,record,number,event,options){this.editMethod(record)},this);this.callParent()},removeMethod:function(record){Ext.Ajax.request({url:this.controllerUrl+'removemethod',method:'post',scope:this,params:{object:record.get('object'),method:record.get('method')},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
designer.msg(appLang.MESSAGE,desLang.msg_methodRemoved);this.getStore().remove(record);this.getStore().commitChanges();this.fireEvent('methodsUpdated')},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},editMethod:function(record){Ext.create('designer.methodEditorWindow',{controllerUrl:this.controllerUrl,objectName:record.get('object'),methodName:record.get('method'),paramsString:record.get('params'),modal:!1,listeners:{'codeSaved':{fn:function(){this.getStore().load();this.fireEvent('methodsUpdated')},scope:this}}}).show()},destroy:function(){this.store.destroy();this.searchField.destroy();this.callParent(arguments)}});Ext.define('designer.methodEditorWindow',{extend:'Ext.Window',modal:!1,width:800,height:600,y:20,layout:{type:'vbox',align:'stretch',pack:'start'},maximizable:!0,extraParams:null,closeAction:'destroy',controllerUrl:'',objectName:'',methodName:'',paramsString:'',editor:null,constructor:function(){this.extraParams={};this.callParent(arguments)},initComponent:function(){this.extraParams.object=this.objectName;this.extraParams.method=this.methodName;this.title=this.objectName+'.'+this.methodName;this.saveButton=Ext.create('Ext.Button',{disabled:!0,text:desLang.save,scope:this,handler:this.saveMethod});this.cancelButton=Ext.create('Ext.Button',{text:desLang.close,scope:this,handler:this.close});this.buttons=[this.saveButton,this.cancelButton];this.centerPanel=Ext.create('Ext.Container',{region:'center',layout:'fit'});this.dataForm=Ext.create('Ext.form.Panel',{bodyPadding:5,bodyCls:'formBody',border:!1,bosyPadding:5,items:[{xtype:'textarea',labelAlign:'top',name:'description',anchor:'100%',fieldLabel:desLang.description},{xtype:'fieldcontainer',layout:{type:'hbox',pack:'start',align:'stretch'},height:22,items:[{xtype:'textfield',name:'method_name',flex:1,fieldStyle:{border:'none',background:'none',backgroundColor:'#F4F4F4'}},{xtype:'displayfield',value:' : <span style="color:#7F0055;font-weight:bold;">function</span>(  '},{xtype:'textfield',name:'params',flex:2,fieldStyle:{border:'none',background:'none',backgroundColor:'#F4F4F4',color:'#5C3BFB'}},{xtype:'displayfield',value:'  )'}]}]});this.items=[this.dataForm];this.callParent();this.on('show',function(){this.loadMethodData();app.checkSize(this);Ext.WindowMgr.register(this);Ext.WindowMgr.bringToFront(this)},this)},loadMethodData:function(){var me=this;Ext.Ajax.request({url:this.controllerUrl+'methoddata',method:'post',scope:this,params:this.extraParams,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
me.editor=Ext.create('designer.codeEditor',{readOnly:!1,showSaveBtn:!1,flex:1,sourceCode:response.data.code,headerText:'{',footerText:'}',extraKeys:{"Ctrl-Space":function(cm){CodeMirror.simpleHint(cm,CodeMirror.javascriptHint)},"Ctrl-S":function(cm){me.saveMethod()},"Ctrl-Z":function(cm){me.editor.undoAction()},"Ctrl-Y":function(cm){me.editor.redoAction()},"Shift-Ctrl-Z":function(cm){me.editor.redoAction()}}});var form=this.dataForm.getForm();form.findField('description').setValue(response.data.description);form.findField('method_name').setValue(response.data.name);form.findField('params').setValue(response.data.paramsLine);this.add(me.editor);this.saveButton.enable()},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},saveMethod:function(){var form=this.dataForm.getForm();var code=this.editor.getValue();var params=Ext.clone(this.extraParams);params.code=code;form.submit({clientValidation:!0,waitMsg:appLang.SAVING,method:'post',scope:this,params:params,url:this.controllerUrl+'update',success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}else{designer.msg(appLang.MESSAGE,desLang.msg_codeSaved);this.fireEvent('codeSaved');this.extraParams.method=form.findField('method_name').getValue();this.methodName=this.extraParams.method}},failure:app.formFailure})},destroy:function(){this.centerPanel.destroy();this.dataForm.destroy();this.callParent(arguments)}});Ext.define('designer.methodsModel',{extend:'Ext.data.Model',fields:[{name:'object',type:'string'},{name:'method',type:'string'},{name:'params',type:'string'},{name:'has_code',type:'boolean'}],idProperty:'method'});Ext.define('designer.methodsPanel',{extend:'Ext.grid.Panel',objectName:'',controllerUrl:'',columnLines:!0,addButton:null,autoLoadData:!0,extraParams:null,searchField:!1,constructor:function(config){Ext.apply({extraParams:{}},config||{});this.callParent(arguments)},initComponent:function(){if(!this.controllerUrl.length){this.controllerUrl=app.createUrl([designer.controllerUrl,'methods',''])}
this.extraParams.object=this.objectName;this.store=Ext.create('Ext.data.Store',{model:'designer.methodsModel',proxy:{type:'ajax',url:this.controllerUrl+'objectmethods',reader:{type:'json',rootProperty:'data'},extraParams:this.extraParams,simpleSortMode:!0},remoteSort:!1,autoLoad:this.autoLoadData,sorters:[{property:'object',direction:'DESC'},{property:'method',direction:'DESC'}]});this.searchField=Ext.create('SearchPanel',{store:this.store,local:!0,width:130,hideLabel:!0,fieldNames:['method']});this.addButton=Ext.create('Ext.Button',{iconCls:'addIcon',text:desLang.addMethod,scope:this,handler:this.addMethod});this.tbar=[this.addButton,'->',this.searchField];this.columns=[{xtype:'actioncolumn',width:20,items:[{width:20,tooltip:desLang.edit,scope:this,iconCls:'editIcon',handler:function(grid,rowIndex){var rec=grid.getStore().getAt(rowIndex);this.editMethod(rec)}}]},{dataIndex:'method',text:desLang.method,flex:1},{dataIndex:'params',text:desLang.params,flex:1},{xtype:'actioncolumn',width:25,items:[{iconCls:'deleteIcon',tooltip:desLang.removeAction,handler:function(grid,rowIndex){var rec=grid.getStore().getAt(rowIndex);this.removeMethod(rec)},width:25,scope:this}]}];this.on('celldblclick',function(table,td,cellIndex,record){this.editMethod(record)},this);this.callParent()},addMethod:function(){Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterMethodName,function(btn,methodName){if(btn!=='ok'){return}
var params=Ext.clone(this.extraParams);params.method=methodName;var store=this.getStore();Ext.Ajax.request({url:this.controllerUrl+'addmethod',method:'post',scope:this,params:params,success:function(response){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
store.load({scope:this,callback:function(){var index=store.findExact('method',methodName);if(index!==-1){this.editMethod(store.getAt(index))}}});this.fireEvent('methodsUpdated')},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this)},removeMethod:function(record){var params=Ext.clone(this.extraParams);params.method=record.get('method');Ext.Ajax.request({url:this.controllerUrl+'removemethod',method:'post',scope:this,params:params,success:function(response){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
designer.msg(appLang.MESSAGE,desLang.msg_methodRemoved);this.getStore().remove(record);this.fireEvent('methodsUpdated')},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},editMethod:function(record){Ext.create('designer.methodEditorWindow',{controllerUrl:this.controllerUrl,objectName:this.objectName,methodName:record.get('method'),paramsString:record.get('params'),extraParams:this.extraParams,modal:!0,listeners:{'codeSaved':{fn:function(){this.getStore().load();this.fireEvent('methodsUpdated')},scope:this}}}).show()},getSearchText:function(){if(this.searchField){return this.searchField.getValue()}else{return''}},setSearchText:function(text){this.searchField.setValue(text)},destroy:function(){this.searchField.destroy();this.store.destroy();this.addButton.destroy();this.callParent(arguments)}});Ext.define('designer.eventsEditorModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'integer'},{name:'object',type:'string'},{name:'event',type:'string'},{name:'params',type:'string'},{name:'is_local',type:'boolean'}],idProperty:'id'});Ext.define('designer.eventsEditor',{extend:'Ext.grid.Panel',scrollable:!0,controllerUrl:null,searchField:null,columnLines:!0,viewConfig:{stripeRows:!0,enableTextSelection:!0},initComponent:function(){if(!this.controllerUrl.length){this.controllerUrl=app.createUrl([designer.controllerUrl,'events',''])}
this.store=Ext.create('Ext.data.Store',{model:'designer.eventsEditorModel',proxy:{type:'ajax',url:this.controllerUrl+'list',reader:{type:'json',rootProperty:'data',idProperty:'id'},simpleSortMode:!0},groupField:'object',remoteSort:!1,autoLoad:!1,sorters:[{property:'object',direction:'DESC'},{property:'event',direction:'DESC'}]});this.searchField=Ext.create('SearchPanel',{store:this.store,local:!0,fieldNames:['object','event']});this.tbar=[{iconCls:'refreshIcon',tooltip:desLang.refresh,scope:this,handler:function(){this.store.load()}},this.searchField];this.columns=[{xtype:'actioncolumn',width:20,items:[{iconCls:'editIcon',handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.editEvent(rec)},scope:this}]},{text:desLang.object,dataIndex:'object',width:150},{text:desLang.event,dataIndex:'event',width:150},{text:desLang.params,dataIndex:'params',flex:1},{xtype:'actioncolumn',width:20,items:[{iconCls:'deleteIcon',handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.removeEvent(rec)},scope:this}]}];this.features=[Ext.create('Ext.grid.feature.Grouping',{groupHeaderTpl:'{name} ({rows.length})',startCollapsed:0,enableGroupingMenu:1,hideGroupedHeader:0})];this.on('itemdblclick',function(view,record,number,event,options){this.editEvent(record)},this);this.callParent()},removeEvent:function(record){Ext.Ajax.request({url:this.controllerUrl+'removeevent',method:'post',scope:this,params:{object:record.get('object'),event:record.get('event')},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
designer.msg(appLang.MESSAGE,desLang.msg_listenerRemoved);this.getStore().remove(record);this.getStore().commitChanges();this.fireEvent('eventsUpdated')},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},editEvent:function(record){Ext.create('designer.eventsEditorWindow',{controllerUrl:this.controllerUrl,objectName:record.get('object'),eventName:record.get('event'),paramsString:record.get('params'),modal:!1,listeners:{'codeSaved':{fn:function(){record.set('has_code',!0);record.commit();this.fireEvent('eventsUpdated')},scope:this}}}).show()}});Ext.define('designer.eventsEditorWindow',{extend:'Ext.Window',modal:!0,width:800,height:600,layout:{type:'vbox',align:'stretch',pack:'start'},autoRender:!0,maximizable:!0,extraParams:null,closeAction:'destroy',controllerUrl:'',objectName:'',eventName:'',paramsString:'',editor:null,loadedConfig:null,constructor:function(){this.extraParams={};this.callParent(arguments)},initComponent:function(){this.extraParams.object=this.objectName;this.extraParams.event=this.eventName;this.title=this.objectName+' on '+this.eventName;this.saveButton=Ext.create('Ext.Button',{disabled:!0,text:desLang.save,scope:this,handler:this.saveEvent});this.cancelButton=Ext.create('Ext.Button',{text:desLang.close,scope:this,handler:this.close});this.buttons=[this.saveButton,this.cancelButton];this.dataForm=Ext.create('Ext.form.Panel',{bodyPadding:5,bodyCls:'formBody',border:!1,bosyPadding:5,autoHeight:!0,split:!1,items:[{xtype:'fieldcontainer',layout:{type:'hbox',pack:'start',align:'stretch'},height:22,items:[{xtype:'textfield',name:'new_name',flex:1,fieldStyle:{border:'none',background:'none',backgroundColor:'#F4F4F4'}},{xtype:'displayfield',value:' : <span style="color:#7F0055;font-weight:bold;">function</span>(  '},{xtype:'textfield',name:'params',flex:2,fieldStyle:{border:'none',background:'none',backgroundColor:'#F4F4F4',color:'#5C3BFB'}},{xtype:'displayfield',value:'  )'}]}]});this.callParent();this.on('show',function(){this.loadCode();app.checkSize(this);Ext.WindowMgr.register(this);Ext.WindowMgr.bringToFront(this)},this)},loadCode:function(){var me=this;Ext.Ajax.request({url:this.controllerUrl+'eventcode',method:'post',scope:this,params:this.extraParams,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
this.loadedConfig=response.data;if(!Ext.isEmpty(response.data.is_local)&&response.data.is_local){me.editor=Ext.create('designer.codeEditor',{readOnly:!1,showSaveBtn:!1,flex:1,sourceCode:response.data.code,headerText:'{',footerText:'}',extraKeys:{"Ctrl-Space":function(cm){CodeMirror.simpleHint(cm,CodeMirror.javascriptHint)},"Ctrl-S":function(cm){me.saveEvent()},"Ctrl-Z":function(cm){me.editor.undoAction()},"Ctrl-Y":function(cm){me.editor.redoAction()},"Shift-Ctrl-Z":function(cm){me.editor.redoAction()}}});var form=this.dataForm.getForm();form.findField('new_name').setValue(response.data.event);form.findField('params').setValue(response.data.params);this.add(this.dataForm)}else{me.editor=Ext.create('designer.codeEditor',{readOnly:!1,showSaveBtn:!1,flex:1,sourceCode:response.data.code,headerText:'<span style="color:blue;font-weight:bold">function</span> ( '+this.paramsString+' ) { ',footerText:'}',extraKeys:{"Ctrl-Space":function(cm){CodeMirror.simpleHint(cm,CodeMirror.javascriptHint)},"Ctrl-S":function(cm){me.saveEvent()},"Ctrl-Z":function(cm){me.editor.undoAction()},"Ctrl-Y":function(cm){me.editor.redoAction()},"Shift-Ctrl-Z":function(cm){me.editor.redoAction()}}})}
this.add(me.editor);this.saveButton.enable()},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},saveEvent:function(){var code=this.editor.getValue();var params=Ext.clone(this.extraParams);params.code=code;if(this.loadedConfig.is_local){var form=this.dataForm.getForm();params.new_name=form.findField('new_name').getValue();params.params=form.findField('params').getValue()}
Ext.Ajax.request({url:this.controllerUrl+'saveevent',method:'post',scope:this,params:params,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
designer.msg(appLang.MESSAGE,desLang.msg_codeSaved);if(this.loadedConfig.is_local){this.eventName=form.findField('new_name').getValue();this.extraParams.event=this.eventName;this.fireEvent('eventUpdated')}else{this.fireEvent('codeSaved')}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})}});Ext.ns('designer.object');Ext.ns('designer.objects');Ext.define('designer.objects.Model',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'title',type:'string'},{name:'objClass',type:'string'}]});Ext.define('designer.objects.Store',{extend:'Ext.data.Store',model:'designer.objects.Model',remoteSort:!1,autoLoad:!1,sorters:[{property:'title',direction:'DESC'}],constructor:function(config){config=Ext.apply({proxy:{type:'ajax',url:(config.controllerUrl||'')+'list',reader:{type:'json',rootProperty:'data',idProperty:'id'},extraParams:config.extraParams||{},simpleSortMode:!0}},config||{});this.callParent(arguments)}});Ext.define('designer.objects.Manager',{extend:'Ext.container.Container',layout:'fit',componentsTree:null,storesStore:null,modelsStore:null,menuStore:null,controllerUrl:'',initComponent:function(){this.menuStore=this.createStore('menu');var me=this;var curListeners={itemSelected:{fn:function(id,objectClass,title,isInstance){me.fireEvent('itemSelected',id,objectClass,title,isInstance)},scope:me},dataChanged:{fn:function(){me.fireEvent('dataChanged')},scope:me},objectRemoved:{fn:function(){me.fireEvent('objectRemoved')},scope:me}};this.componentsTree=Ext.create('designer.objects.Tree',{listType:'visual',controllerUrl:this.controllerUrl,listeners:curListeners});this.storesStore=this.createStore('stores');this.modelsStore=this.createStore('models');this.items=[this.componentsTree];this.callParent()},clearData:function(){this.componentsTree.getStore().getRootNode().removeAll();this.storesStore.removeAll();this.modelsStore.removeAll();this.menuStore.removeAll()},loadInfo:function(){this.componentsTree.reload();this.storesStore.load();this.modelsStore.load();this.menuStore.load()},createStore:function(type){var s=Ext.create('designer.objects.Store',{controllerUrl:this.controllerUrl,extraParams:{type:type}});return s}});Ext.define('designer.objects.TreeModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'text',type:'string'},{name:'objClass',type:'string'},{name:'isInstance',type:'boolean'}],idProperty:'id'});Ext.define('designer.objects.StatefullTree',{extend:'Ext.tree.Panel',getNodesState:function(){var state={};this.getStore().each(function(node){if(node.isExpanded()){state[node.get('id')]=!0}});return state},applyNodesState:function(state){this.getStore().each(function(node){if(Ext.isEmpty(node)){return}
if(!Ext.isEmpty(state[node.get('id')])){node.expand()}else{node.collapse()}})}});Ext.define('designer.objects.Tree',{extend:'Ext.Panel',controllerUrl:'',listType:'visual',layout:'fit',firstLoad:!0,selectedNode:!1,initComponent:function(){this.nodesState={};this.dataStore=Ext.create('Ext.data.TreeStore',{model:'designer.objects.TreeModel',proxy:{type:'ajax',url:this.controllerUrl+'visuallist',reader:{type:'json',idProperty:'id'},},defaultRootId:'_ROOT_',defaultRootText:'/',clearOnLoad:!0,autoLoad:!1,listeners:{load:{fn:function(store){this.treePanel.applyNodesState(this.nodesState)},scope:this}}});this.treePanel=Ext.create('designer.objects.StatefullTree',{store:this.dataStore,rootVisible:!1,useArrows:!0,viewConfig:{plugins:{ptype:'treeviewdragdrop'},listeners:{drop:{fn:this.sortChanged,scope:this},nodedragover:function(targetNode,position,dragData){var rec=dragData.records[0],isFirst=targetNode.isFirst(),isRoot=targetNode.isRoot();if(isRoot)
return!1;return(!(targetNode.parentNode.isRoot()&&position!='append'))},scope:this}}});this.treePanel.on('select',function(tree,record,index,eOpts){this.selectedNode=record},this);this.dataStore.on('load',function(){if(this.selectedNode){this.treePanel.getSelectionModel().select(this.selectedNode);this.treePanel.getView().focusRow(this.selectedNode)}},this);this.treePanel.addListener('itemclick',function(view,record,element,index,e,eOpts){this.fireEvent('itemSelected',record.get('id'),record.get('objClass'),record.get('text'),record.get('isInstance'))},this);this.collapseBtn=Ext.create('Ext.Button',{icon:app.wwwRoot+'i/system/collapse-tree.png',tooltip:desLang.collapseAll,listeners:{click:{fn:function(){this.treePanel.collapseAll();this.collapseBtn.disable();this.expandBtn.enable()},scope:this}}});this.expandBtn=Ext.create('Ext.Button',{tooltip:desLang.expandAll,icon:app.wwwRoot+'i/system/expand-tree.png',disabled:!0,listeners:{click:{fn:function(){this.treePanel.expandAll();this.collapseBtn.enable();this.expandBtn.disable()},scope:this}}});this.tbar=[this.collapseBtn,this.expandBtn,'->',{tooltip:desLang.remove,iconCls:'deleteIcon',handler:this.removeObject,scope:this}];this.items=[this.treePanel];this.callParent(arguments);this.treePanel.on('scrollershow',function(scroller){if(scroller&&scroller.scrollEl){scroller.clearManagedListeners();scroller.mon(scroller.scrollEl,'scroll',scroller.onElScroll,scroller)}},this)},reload:function(){this.nodesState=this.treePanel.getNodesState();this.dataStore.removeAll();this.dataStore.load()},getStore:function(){return this.dataStore},sortChanged:function(node,data,overModel,dropPosition,options){var parentId=0;var parentNode=null;if(dropPosition=='append'){parentId=overModel.get('id');parentNode=overModel}else{parentId=overModel.parentNode.get('id');parentNode=overModel.parentNode}
var childsOrder=[];parentNode.eachChild(function(node){childsOrder.push(node.getId())},this);Ext.Ajax.request({url:this.controllerUrl+'sort',method:'post',params:{'id':data.records[0].get('id'),'newparent':parentId,'order[]':childsOrder},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.fireEvent('dataChanged');this.updateLayout()}else{this.reload();Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:app.formFailure})},removeObject:function(){var sm=this.treePanel.getSelectionModel();if(!sm.hasSelection()||sm.getSelection()[0].get('id')=='0'){Ext.Msg.alert(appLang.MESSAGE,desLang.msg_selectForRemove);return}
var me=this;var selected=sm.getSelection()[0];if(selected.get('objClass')=='Docked'){Ext.Msg.alert(appLang.MESSAGE,desLang.cantDeleteDocked);return}
if(selected.get('objClass')=='Designer_Project_Container'){return}
Ext.Ajax.request({url:this.controllerUrl+'remove',method:'post',params:{'id':selected.get('id')},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.fireEvent('objectRemoved');me.fireEvent('dataChanged');me.getStore().remove(selected)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:app.formFailure})}});Ext.define('designer.objects.Grid',{extend:'Ext.Panel',layout:'fit',dataStore:null,dataGrid:null,initComponent:function(){this.dataGrid=Ext.create('Ext.grid.Panel',{store:this.dataStore,columns:[{text:desLang.name,dataIndex:'title',flex:1},{xtype:'actioncolumn',width:30,items:[{iconCls:'deleteIcon',title:desLang.remove,scope:this,handler:this.removeObject}]}],viewConfig:{stripeRows:!1},frame:!1,loadMask:!0,columnLines:!0,scrollable:!0,listeners:{'itemclick':{fn:function(view,record,number,event,options){this.fireEvent('itemSelected',record.get('id'),record.get('objClass'),record.get('title'),!1)},scope:this}}});this.items=[this.dataGrid];this.callParent(arguments)},getStore:function(){return this.dataStore},removeObject:function(grid,rowIndex,colIndex){var record=grid.getStore().getAt(rowIndex);Ext.Ajax.request({url:this.controllerUrl+'remove',method:'post',params:{'id':record.get('id')},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){grid.getStore().remove(record);this.fireEvent('objectRemoved');this.fireEvent('dataChanged')}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:app.formFailure})}});Ext.ns('designer.grid','designer.grid.column');Ext.define('designer.grid.exportFieldsWin',{extend:'Ext.Window',layout:'fit',title:desLang.importStore,width:300,height:250,modal:!0,controllerUrl:null,objectName:null,dataGrid:null,dataStore:null,initComponent:function(){this.dataStore=Ext.create('Ext.data.Store',{model:'designer.model.fieldsModel',proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store',''])+'allStoreFields',reader:{type:'json',rootProperty:'data',idProperty:'id'},extraParams:{object:this.objectName},simpleSortMode:!0},autoLoad:!0});this.dataGrid=Ext.create('Ext.grid.Panel',{border:!1,store:this.dataStore,selModel:Ext.create('Ext.selection.CheckboxModel'),columns:[{text:desLang.field,dataIndex:'name',flex:1},{text:desLang.type,dataIndex:'type',width:85}]});this.items=[this.dataGrid];this.buttons=[{text:desLang.select,scope:this,handler:this.addFields},{text:desLang.cancel,scope:this,handler:this.close}];this.callParent(arguments)},addFields:function(){records=this.dataGrid.getSelectionModel().getSelection();var col=[];Ext.each(records,function(record){col.push({name:record.get('name'),type:record.get('type')})},this);Ext.Ajax.request({url:this.controllerUrl+'addcolumns',method:'post',params:{'col':Ext.encode(col),'object':this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.fireEvent('allSet')}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},destroy:function(){this.dataStore.destroy();this.dataGrid.destroy();this.callParent(arguments)}});Ext.define('designer.grid.filterOptionsModel',{extend:'Ext.data.Model',fields:[{name:'value',type:'string'}]});Ext.define('designer.grid.filterOptionsWindow',{extend:'Ext.Window',width:500,height:300,layout:'fit',modal:!0,title:desLang.items,dataGrid:null,dataStore:null,initialData:[],cellEditing:null,objectName:null,controllerUrl:null,initComponent:function(){this.tbar=[{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addRecord}];this.dataStore=Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.grid.filterOptionsModel',data:this.initialData,autoLoad:!1});this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.dataGrid=Ext.create('Ext.grid.Panel',{columnLines:!0,autoHeight:!0,store:this.dataStore,columns:[{text:desLang.value,dataIndex:'value',flex:1,editor:{xtype:'textfield'}},{xtype:'actioncolumn',width:25,sortable:!1,menuDisabled:!0,align:'center',items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();store.remove(store.getAt(row))}}]}],plugins:[this.cellEditing]});this.items=[this.dataGrid];this.buttons=[{text:desLang.save,handler:this.saveData,scope:this},{text:desLang.close,handler:function(){this.close()},scope:this}];this.callParent(arguments)},addRecord:function(){var count=this.dataStore.getCount();var r=Ext.create('designer.grid.filterOptionsModel',{name:''});this.dataStore.insert(count,r);this.cellEditing.startEditByPosition({row:count,column:0})},saveData:function(){this.dataStore.commitChanges();var options=[];this.dataStore.each(function(record){options.push(record.get('value'))});this.fireEvent('dataChanged','options',Ext.encode(options),!0);this.close()},destroy:function(){this.dataStore.destroy();this.dataGrid.destroy();this.cellEditing.destroy();this.callParent(arguments)}});Ext.define('designer.grid.column.Model',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'text',type:'string'},{name:'dataIndex',type:'string'},{name:'type',type:'string'},{name:'editor',type:'string'},{name:'filter',type:'string'},{name:'order',type:'integer'}],idProperty:'id'});Ext.define('designer.grid.column.Window',{extend:'Ext.Window',layout:'border',dataStore:null,width:app.checkWidth(900),height:app.checkHeight(650),propertiesPanel:null,objectName:null,controllerUrl:null,cellEditing:null,dataTree:null,dataGrid:null,modal:!0,autoLoadData:!0,maximizable:!0,initComponent:function(){this.controllerUrl=app.createUrl([designer.controllerUrl,'grid','']);this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.initColumnsGrid();this.initColumnsTree();this.dataGrid.getSelectionModel().on('selectionchange',function(sm,data,opts){if(!sm.hasSelection()){this.propertiesPanel.resetProperties();this.propertiesPanel.refreshEvents();return}
var colId=sm.getSelection()[0].get('id');this.propertiesPanel.setExtraParams({'id':colId,'columnId':colId});this.propertiesPanel.loadProperties();this.propertiesPanel.refreshEvents()},this);this.dataTree.getSelectionModel().on('selectionchange',function(sm){this.cellEditing.completeEdit();if(!sm.hasSelection()){return}
var recId=sm.getSelection()[0].get('id');var index=this.dataGrid.getStore().findExact('id',recId);if(index!=-1){this.dataGrid.getSelectionModel().select(index)}},this);this.propertiesPanel=Ext.create('designer.properties.GridColumn',{controllerUrl:app.createUrl([designer.controllerUrl,'gridcolumn','']),eventsControllerUrl:app.createUrl([designer.controllerUrl,'gridcolumnevents','']),objectName:this.objectName,autoLoad:!1,listeners:{dataSaved:{fn:function(){},scope:this}},title:desLang.properties,layout:'fit',region:'east',showEvents:!0,split:!0,width:250});this.propertiesPanel.dataGrid.on('propertychange',function(source,recordId,value){if(recordId=='text'){this.treeStore.load();var gridStore=this.dataGrid.getStore();var index=gridStore.findExact('id',recordId);if(index!==-1){var record=gridStore.getAt(index);if(record.get('text')!==value){record.set('text',value);record.commit()}}}},this);this.items=[this.dataTree,this.dataGrid,this.propertiesPanel];this.callParent(arguments);this.reload();this.on('show',function(){app.checkSize(this)})},initColumnsGrid:function(){this.dataStore=Ext.create('Ext.data.Store',{proxy:{type:'ajax',url:this.controllerUrl+'columnlist',reader:{type:'json',idProperty:'id',rootProperty:'data'},extraParams:{object:this.objectName}},model:'designer.grid.column.Model',autoLoad:!0,sorters:[{property:'order',direction:'ASC'}]});this.dataGrid=Ext.create('Ext.grid.Panel',{tbar:[{tooltip:desLang.addColumn,iconCls:'plusIcon',scope:this,handler:this.addColumn},{tooltip:desLang.importStore,iconCls:'importDbIcon',scope:this,handler:this.importFieldsFromStore}],store:this.dataStore,region:'center',split:!0,title:desLang.columns,columnLines:!0,columns:[{xtype:'actioncolumn',width:30,align:'center',items:[{iconCls:'filterIcon',tooltip:desLang.configureFilter,scope:this,handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.showFilterWindow(rec.get('id'))}}]},{xtype:'actioncolumn',width:30,align:'center',items:[{iconCls:'fieldIcon',tooltip:desLang.configureEditor,scope:this,handler:this.showEditorConfig}]},{text:desLang.editor,dataIndex:'editor',width:100},{align:'center',text:desLang.filter,dataIndex:'filter',width:60},{dataIndex:'text',text:desLang.header,flex:1,editor:{xtype:'textfield',flex:1,width:200,editable:!0}},{dataIndex:'dataIndex',text:desLang.dataIndex,editable:!0,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,valueField:'name',displayField:'name',queryMode:'local',multiSelect:!1,store:Ext.create('Ext.data.Store',{model:'designer.model.fieldsModel',proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store',''])+'allStoreFields',reader:{type:'json',rootProperty:'data'},extraParams:{object:this.objectName},simpleSortMode:!0},remoteSort:!0,autoLoad:!0,sorters:[{property:'title',direction:'DESC'}]}),listeners:{select:{fn:function(combo,record){this.propertiesPanel.dataGrid.setProperty('dataIndex',record.get('name'))},scope:this}}}},{dataIndex:'type',text:desLang.type,editable:!0,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,store:[['','Simple'],['action','Action'],['date','Date'],['boolean','Boolean'],['number','Number'],['template','Template'],['check','Check']],listeners:{scope:this,select:function(combo,records,eOpts){var columnId=this.dataGrid.getSelectionModel().getLastSelected().get('id');Ext.Ajax.request({url:this.controllerUrl+'changecoltype/',method:'post',params:{'object':this.objectName,'type':records.get('field1'),'columnId':columnId},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.propertiesPanel.setExtraParams({'id':columnId,'columnId':columnId});this.propertiesPanel.loadProperties();this.propertiesPanel.refreshEvents();this.propertiesPanel.resetSerchField()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);return!1}},failure:app.formFailure})}}}},{xtype:'actioncolumn',width:30,align:'center',items:[{iconCls:'deleteIcon',scope:this,tooltip:desLang.remove,handler:this.removeColumn}]}],plugins:[this.cellEditing],listeners:{scope:this,edit:function(editor,o){if(o.field==='text'){this.propertiesPanel.dataGrid.setProperty('text',o.value)}
this.dataStore.commitChanges()}}})},initColumnsTree:function(){this.treeStore=Ext.create('Ext.data.TreeStore',{proxy:{type:'ajax',url:this.controllerUrl+'columnlisttree',reader:{type:'json',idProperty:'id'},extraParams:{object:this.objectName},autoLoad:!0},root:{text:'/',expanded:!0,leaf:!1,children:[]},defaultRootId:0,clearOnLoad:!0,autoLoad:!0});this.dataTree=Ext.create('Ext.tree.Panel',{region:'west',width:200,collapsible:!0,collapseMode:'header',collapseFirst:!0,clearOnLoad:!0,store:this.treeStore,split:!0,rootVisible:!1,useArrows:!1,collapsed:!0,title:desLang.columnsTree,viewConfig:{plugins:{ptype:'treeviewdragdrop'},listeners:{drop:{fn:this.sortChanged,scope:this}}}})},sortChanged:function(node,data,overModel,dropPosition,options){var parentId=0;var parentNode=null;if(dropPosition=='append'){parentId=overModel.get('id');parentNode=overModel}else{parentId=overModel.parentNode.get('id');parentNode=overModel.parentNode}
var childsOrder=[];parentNode.eachChild(function(node){childsOrder.push(node.getId())},this);Ext.Ajax.request({url:this.controllerUrl+'columnsort',method:'post',params:{'id':data.records[0].get('id'),'newparent':parentId,'order[]':childsOrder,'object':this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.load();this.fireEvent('dataChanged')}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:app.formFailure})},removeColumn:function(grid,row,col){var record=grid.getStore().getAt(row);Ext.MessageBox.confirm(appLang.MESSAGE,desLang.remove+'?',function(btn){if(btn!='yes'){return}
Ext.Ajax.request({url:this.controllerUrl+'removecolumn',method:'post',params:{'id':record.get('id'),'object':this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.reload()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this)},reload:function(){this.treeStore.getRootNode().removeAll();this.treeStore.load({});this.dataStore.load()},showEditorConfig:function(grid,row,col){var window=Ext.create('Ext.Window',{width:300,height:400,modal:!0,title:desLang.configureEditor,layout:'fit',items:[]});var colId=grid.getStore().getAt(row).get('id');var properties=Ext.create('designer.properties.GridEditor',{controllerUrl:app.createUrl([designer.controllerUrl,'editor','']),eventsControllerUrl:app.createUrl([designer.controllerUrl,'editor','']),objectName:this.objectName,extraParams:{column:colId},columnName:colId,listeners:{'objectsUpdated':{fn:function(){this.dataGrid.getStore().load()},scope:this},'editorRemoved':{fn:function(){this.dataGrid.getStore().load();window.close()},scope:this}}});window.add(properties);window.show()},addColumn:function(){Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterColumnId,function(btn,text){if(btn!='ok'){return}
Ext.Ajax.request({url:this.controllerUrl+'addcolumn',method:'post',params:{'id':text,'object':this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.reload()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this)},importFieldsFromStore:function(){var win=Ext.create('designer.grid.exportFieldsWin',{controllerUrl:this.controllerUrl,objectName:this.objectName});win.on('allSet',function(){this.reload();win.close()},this);win.show()},showFilterWindow:function(column){var win=Ext.create('designer.grid.column.FilterWindow',{title:desLang.filter,objectName:this.objectName,columnId:column,controllerUrl:this.controllerUrl});win.on('filterChange',function(){this.reload()},this);Ext.defer(function(){win.show().toFront()},50)}});Ext.define('designer.grid.column.FilterWindow',{extend:'Ext.Window',layout:'border',width:app.checkWidth(350),height:app.checkHeight(500),bodyCls:'formBody',bodyPadding:5,modal:!0,objectName:null,columnId:null,controllerUrl:null,propertiesPanel:null,initComponent:function(){this.typeSelector=Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:50,forceSelection:!0,queryMode:'local',fieldLabel:desLang.type,region:'north',displayField:'title',valueField:'id',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',data:[{id:'boolean',title:'boolean'},{id:'date',title:'date'},{id:'list',title:'list'},{id:'number',title:'number'},{id:'string',title:'string'}]}),listeners:{change:{fn:function(){this.setFilterType()},scope:this}}});this.propertiesPanel=Ext.create('designer.properties.Panel',{autoLoadData:!1,controllerUrl:app.createUrl([designer.controllerUrl,'gridcolumnfilter','']),eventsControllerUrl:app.createUrl([designer.controllerUrl,'gridcolumnfilterevents','']),extraParams:{column:this.columnId},region:'center',objectName:this.objectName,listeners:{dataSaved:{fn:function(){},scope:this}},layout:'fit'});this.items=[this.typeSelector,this.propertiesPanel];this.buttons=[{text:desLang.removeFilter,handler:this.removeFilter,scope:this},{text:desLang.close,handler:function(){this.close()},scope:this}];this.callParent();this.on('show',this.loadFilter,this)},loadFilter:function(){this.getEl().mask(desLang.saving);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'gridcolumnfilter','gettype']),method:'post',scope:this,params:{column:this.columnId,object:this.objectName},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);this.getEl().unmask();this.close()}else{if(!Ext.isEmpty(response.data.type)){this.typeSelector.setRawValue(response.data.type);this.propertiesPanel.loadProperties();this.propertiesPanel.refreshEvents()}
this.getEl().unmask()}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);this.getEl().unmask()}})},setFilterType:function(){this.getEl().mask(desLang.saving);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'gridcolumnfilter','settype']),method:'post',scope:this,params:{column:this.columnId,object:this.objectName,type:this.typeSelector.getValue()},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);this.getEl().unmask();this.close()}else{this.getEl().unmask();designer.msg(desLang.success,desLang.filterSaved);this.propertiesPanel.loadProperties();this.propertiesPanel.refreshEvents();this.fireEvent('filterChange')}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);this.getEl().unmask()}})},removeFilter:function(){this.getEl().mask(desLang.saving);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'gridcolumnfilter','removefilter']),method:'post',scope:this,params:{column:this.columnId,object:this.objectName},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);this.getEl().unmask()}else{this.getEl().unmask();this.fireEvent('filterChange');this.close()}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION);this.getEl().unmask()}})}});Ext.define('designer.grid.column.ActionsWindow',{extend:'Ext.Window',layout:'border',width:app.checkWidth(700),height:app.checkHeight(500),modal:!0,objectName:null,columnId:null,controllerUrl:null,dataGrid:null,dataStore:null,propertiesPanel:null,initComponent:function(){this.dataStore=Ext.create('Ext.data.Store',{proxy:{type:'ajax',url:this.controllerUrl+'itemslist',reader:{type:'json',idProperty:'id',rootProperty:'data'},extraParams:{object:this.objectName,column:this.columnId}},fields:[{name:'id',type:'string'},{name:'tooltip',type:'string'},{name:'icon',type:'string'}],autoLoad:!0,sorters:[{property:'order',direction:'ASC'}]});var me=this;var bufferedSave=Ext.Function.createBuffered(me.saveOrder,1200,me);this.dataGrid=Ext.create('Ext.grid.Panel',{store:this.dataStore,region:'center',split:!0,columnLines:!0,tbar:[{text:desLang.add,scope:this,handler:this.addActionItem}],columns:[{dataIndex:'icon',renderer:function(v){if(v.length){return'<img src="'+v+'"/>'}},width:50,align:'center',text:desLang.icon,sortable:!1},{dataIndex:'tooltip',text:desLang.tooltip,flex:1,sortable:!1},{xtype:'actioncolumn',width:60,tooltip:appLang.SORT,dataIndex:'id',sortable:!1,items:[{iconCls:'downIcon',handler:function(grid,rowIndex,colIndex){var total=grid.getStore().getCount();if(rowIndex==total-1)
return;var sRec=grid.getStore().getAt(rowIndex);grid.getStore().removeAt(rowIndex);grid.getStore().insert(rowIndex+1,sRec);bufferedSave()}},{iconCls:'upIcon',handler:function(grid,rowIndex,colIndex){var total=grid.getStore().getCount();if(rowIndex==0)
return;var sRec=grid.getStore().getAt(rowIndex);grid.getStore().removeAt(rowIndex);grid.getStore().insert(rowIndex-1,sRec);bufferedSave()}},{iconCls:'deleteIcon',tooltip:desLang.removeAction,scope:this,handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);this.removeAction(rec)}}]}]});this.propertiesPanel=Ext.create('designer.properties.GridColumn',{autoLoadData:!1,controllerUrl:app.createUrl([designer.controllerUrl,'gridcolumnactions','']),eventsControllerUrl:app.createUrl([designer.controllerUrl,'gridcolumnactionevents','']),extraParams:{column:this.columnId},objectName:this.objectName,width:380,listeners:{dataSaved:{fn:function(){},scope:this}},title:desLang.properties,layout:'fit',region:'east',split:!0,width:250});this.propertiesPanel.dataGrid.on('propertychange',function(source,recordId,value){switch(recordId){case 'tooltip':var sm=this.dataGrid.getSelectionModel();if(sm.hasSelection()){var record=sm.getSelection()[0];record.beginEdit();record.set(recordId,value);record.endEdit();record.commit()}
break;case 'icon':this.dataStore.load();break;default:return}},this);this.dataGrid.getSelectionModel().on('selectionchange',function(sm,data,opts){if(!sm.hasSelection()){this.propertiesPanel.resetProperties();return}
this.propertiesPanel.setExtraParams({'id':sm.getSelection()[0].get('id')});this.propertiesPanel.loadProperties();this.propertiesPanel.refreshEvents()},this);this.items=[this.dataGrid,this.propertiesPanel];this.callParent()},saveOrder:function(){var order=[];this.dataStore.each(function(record){order.push(record.get('id'))},this);Ext.Ajax.request({url:this.controllerUrl+'sortactions',method:'post',scope:this,params:{'object':this.objectName,'column':this.columnId,'order[]':order},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg)}else{designer.msg(desLang.success,desLang.sortSaved)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},addActionItem:function(){Ext.Msg.prompt(appLang.MESSAGE,desLang.enterActionName,function(btn,text){if(btn!='ok'){return}
Ext.Ajax.request({url:this.controllerUrl+'addaction',method:'post',scope:this,params:{'name':text,'object':this.objectName,'column':this.columnId},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.load();designer.msg(desLang.success,desLang.actionAdded)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this)},removeAction:function(record){var me=this;Ext.MessageBox.confirm(appLang.CONFIRMATION,desLang.removeAction+' "'+record.get('text')+'"',function(btn){if(btn!='yes'){return}
Ext.Ajax.request({url:me.controllerUrl+'removeaction',method:'post',params:{'name':record.get('id'),'object':me.objectName,'column':me.columnId},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.dataStore.remove(record);designer.msg(desLang.success,desLang.actionRemoved)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})})}});Ext.define('designer.grid.column.RendererWindow',{extend:'Ext.Window',layout:'fit',objectName:'',columnId:'',controllerUrl:'',width:400,height:500,maximizable:!0,modal:!0,initComponent:function(){var me=this;this.renderersStore=Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'renderers',reader:{type:'json',rootProperty:'data',idProperty:'id'},extraParams:{object:this.objectName},simpleSortMode:!0},remoteSort:!1,autoLoad:!0,sorters:[{property:'title',direction:'DESC'}]});this.dictionaryStore=Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'dictionaries',reader:{type:'json',rootProperty:'data',idProperty:'id'},extraParams:{object:this.objectName},simpleSortMode:!0},remoteSort:!1,autoLoad:!0,sorters:[{property:'title',direction:'DESC'}]});this.callEditor=Ext.create('designer.codeEditor',{readOnly:!1,showSaveBtn:!1,hidden:!0,flex:1,anchor:'100%',hideLabel:!0,sourceCode:'',name:'call',extraKeys:{"Ctrl-Space":function(cm){CodeMirror.simpleHint(cm,CodeMirror.javascriptHint)},"Ctrl-S":function(cm){me.saveData()},"Ctrl-Z":function(cm){me.callEditor.undoAction()},"Ctrl-Y":function(cm){me.callEditor.redoAction()},"Shift-Ctrl-Z":function(cm){me.callEditor.redoAction()}}});this.rendererAdapter=Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,queryMode:'local',displayField:'title',valueField:'id',fieldLabel:desLang.renderer,store:this.renderersStore,hidden:!0,name:'adapter'});this.dictionaryAdapter=Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,queryMode:'local',displayField:'title',valueField:'id',fieldLabel:desLang.dictionary,store:this.dictionaryStore,hidden:!0,name:'dictionary'});this.typeBox=Ext.create('Ext.form.field.ComboBox',{fieldLabel:desLang.rendererType,name:'type',forceSelection:!0,displayField:'title',valueField:'id',allowBlank:!1,store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',data:[{id:'adapter',title:desLang.adapter},{id:'jscall',title:desLang.jsCall},{id:'jscode',title:desLang.extRenderer},{id:'dictionary',title:desLang.dictionary}]}),queryMode:'local',listeners:{change:{fn:this.onTypeSelected,scope:this}}});this.editor=Ext.create('designer.codeEditor',{readOnly:!1,showSaveBtn:!1,hidden:!0,flex:1,sourceCode:'',name:'code',headerText:'{',footerText:'}',extraKeys:{"Ctrl-Space":function(cm){CodeMirror.simpleHint(cm,CodeMirror.javascriptHint)},"Ctrl-S":function(cm){me.saveData()},"Ctrl-Z":function(cm){me.editor.undoAction()},"Ctrl-Y":function(cm){me.editor.redoAction()},"Shift-Ctrl-Z":function(cm){me.editor.redoAction()}}});this.codeEditorHead=Ext.create('Ext.form.FieldContainer',{hidden:!0,layout:{type:'hbox',pack:'start',align:'stretch'},height:22,items:[{xtype:'displayfield',value:' <span style="color:#7F0055;font-weight:bold;">function</span>(&nbsp;'},{xtype:'textfield',name:'params',flex:2,readOnly:!0,fieldStyle:{border:'none',background:'none',backgroundColor:'#F4F4F4',color:'#5C3BFB'},value:' value, metaData, record, rowIndex, colIndex, store, view'},{xtype:'displayfield',value:'&nbsp;  )'}]});this.dataForm=Ext.create('Ext.form.Panel',{bodyCls:'formBody',layout:{type:'vbox',align:'stretch',pack:'start'},bodyPadding:4,fieldDefaults:{labelWidth:90,labelAlign:'right'},items:[this.typeBox,this.rendererAdapter,this.dictionaryAdapter,this.callEditor,this.codeEditorHead,this.editor]});this.items=[this.dataForm];this.buttons=[{text:desLang.save,scope:this,handler:this.saveData},{text:desLang.cancel,scope:this,handler:this.close}];this.callParent();this.loadData()},onTypeSelected:function(combo,v){this.rendererAdapter.hide();this.codeEditorHead.hide();this.editor.hide();this.callEditor.hide();this.dictionaryAdapter.hide();switch(v){case 'dictionary':this.dictionaryAdapter.show();break;case 'jscall':this.callEditor.show();break;case 'jscode':this.codeEditorHead.show();this.editor.show();break;case 'adapter':default:this.rendererAdapter.show();break}},loadData:function(){var form=this.dataForm.getForm();var me=this;form.load({waitMsg:desLang.loading,url:this.controllerUrl+'rendererload',method:'post',params:{'object':this.objectName,'column':this.columnId},success:function(form,action){if(action.result.success){if(!Ext.isEmpty(action.result.data.call)){me.callEditor.setValue(action.result.data.call)}
if(!Ext.isEmpty(action.result.data.code)){me.editor.setValue(action.result.data.code)}
me.fireEvent('dataLoaded',action.result)}else{Ext.Msg.alert(desLang.message,action.result.msg).toFront();me.close()}},failure:app.formFailure})},saveData:function(){var me=this;var form=this.dataForm.getForm();form.submit({clientValidation:!0,method:'post',url:this.controllerUrl+'renderersave',params:{'object':this.objectName,'column':this.columnId,'code':this.editor.getValue(),'call':this.callEditor.getValue()},waitMsg:appLang.SAVING,success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);return}
me.fireEvent('dataSaved');me.close()},failure:app.formFailure})}});Ext.define('designer.grid.filters.Model',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'dataIndex',type:'string'},{name:'type',type:'string'},{name:'active',type:'boolean'}],isProperty:'id'});Ext.define('designer.grid.filters.Window',{extend:'Ext.Window',layout:'fit',width:700,height:500,objectName:null,title:desLang.filtersFeature,initComponent:function(){this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.dataStore=Ext.create('Ext.data.Store',{model:'designer.grid.filters.Model',proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'gridfilters','filterlist']),reader:{type:'json',rootProperty:'data'},extraParams:{object:this.objectName}},autoLoad:!0,sorters:[{property:'dataIndex',direction:'ASC'}]});this.properties=Ext.create('designer.properties.Panel',{controllerUrl:app.createUrl([designer.controllerUrl,'gridfilters','']),objectName:this.objectName,width:380,autoLoad:!1,listeners:{dataSaved:{fn:function(){this.fireEvent('dataSaved')},scope:this}},title:desLang.properties,mainConfigTitle:!1,layout:'fit',showEvents:!1,useTabs:!1});this.itemsPanel=Ext.create('Ext.grid.Panel',{tbar:[{tooltip:desLang.addFilter,iconCls:'plusIcon',scope:this,handler:this.addFilter}],store:this.dataStore,region:'center',split:!0,title:desLang.filters,columnLines:!0,columns:[{text:desLang.dataIndex,dataIndex:'dataIndex',flex:1,editable:!0,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,valueField:'name',displayField:'name',queryMode:'local',store:Ext.create('Ext.data.Store',{model:'designer.model.fieldsModel',proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store',''])+'listStoreFields',reader:{type:'json',rootProperty:'data',idProperty:'id'},extraParams:{object:this.objectName},simpleSortMode:!0},remoteSort:!0,autoLoad:!0,sorters:[{property:'title',direction:'DESC'}]}),listeners:{scope:this,select:function(combo,record){this.itemPropertiesPanel.dataGrid.setProperty('dataIndex',record.get('name'))}}}},{text:desLang.type,dataIndex:'type',editable:!0,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,store:[['string','String'],['date','Date'],['datetime','Date time'],['boolean','Boolean'],['list','List'],['numeric','Numeric']],listeners:{scope:this,select:function(combo,record,eOpts){var filterId=this.itemPropertiesPanel.getExtraParam('id');Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'gridfilters','changefiltertype']),method:'post',params:{'object':this.objectName,'type':record.get('field1'),'filterid':filterId},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.itemPropertiesPanel.setExtraParams({'id':filterId});this.itemPropertiesPanel.loadProperties();this.itemPropertiesPanel.resetSerchField();record.commit()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg);return!1}},failure:app.formFailure})}}}},{text:desLang.active,dataIndex:'active',renderer:app.checkboxRenderer,width:60,align:'center',editable:!0,editor:{xtype:'checkbox',listeners:{scope:this,change:function(cb,value){this.itemPropertiesPanel.dataGrid.setProperty('active',value)}}}},{xtype:'actioncolumn',width:20,items:[{iconCls:'deleteIcon',scope:this,tooltip:desLang.remove,handler:this.removeFilter}]}],plugins:[this.cellEditing],region:'center',split:!0});this.itemPropertiesPanel=Ext.create('designer.properties.GridFilter',{controllerUrl:app.createUrl([designer.controllerUrl,'gridfilter','']),eventsControllerUrl:app.createUrl([designer.controllerUrl,'gridfilterevents','']),objectName:this.objectName,width:300,autoLoad:!1,listeners:{dataSaved:{fn:function(){},scope:this}},layout:'fit',region:'east',showEvents:!0,split:!0,region:'east',split:!0});this.callParent();this.add({xtype:'tabpanel',deferredRender:!1,items:[this.properties,{xtype:'panel',layout:'border',title:desLang.filters,items:[this.itemsPanel,this.itemPropertiesPanel]}]});this.on('show',function(){app.checkSize(this)});this.itemsPanel.getSelectionModel().on('selectionchange',function(sm,data,opts){if(!sm.hasSelection()){this.itemPropertiesPanel.resetProperties();return}
this.itemPropertiesPanel.setExtraParams({'id':sm.getSelection()[0].get('id')});this.itemPropertiesPanel.loadProperties()},this)},addFilter:function(){Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterFilterId,function(btn,text){if(btn!='ok'){return}
Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'gridfilters','addfilter']),method:'post',params:{'id':text,'object':this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this)},removeFilter:function(grid,row,col){var record=grid.getStore().getAt(row);Ext.MessageBox.confirm(appLang.MESSAGE,desLang.remove+'?',function(btn){if(btn!='yes'){return}
Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'gridfilters','removefilter']),method:'post',params:{'id':record.get('id'),'object':this.objectName},scope:this,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){grid.getStore().load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this)}});Ext.ns('designer.properties');Ext.define('designer.properties.idStringModel',{extend:'Ext.data.Model',idProperty:'id',fields:[{name:'id',type:'string'}]});Ext.define('designer.properties.nameTitleModel',{extend:'Ext.data.Model',idProperty:'name',fields:[{name:'name',type:'string'},{name:'title',type:'string'}]});Ext.define('designer.properties.Panel',{extend:'Ext.Panel',layout:'fit',border:!1,searchPanel:null,dataStore:null,dataGrid:null,controllerUrl:'',scrollable:!1,controllerUr:'',eventsControllerUrl:'',eventsPanel:null,methodsPanel:null,objectName:null,tabs:null,showEvents:!0,showMethods:!1,extraParams:null,alignData:[['left'],['center'],['right']],labelAlignData:[['left'],['top'],['right']],iconAlignData:[['top'],['right'],['bottom'],['left']],regionData:[['center'],['west'],['north'],['east'],['south']],layoutData:[['Auto'],['border'],['card'],['fit'],['hbox'],['vbox'],['anchor'],['center'],['absolute']],dockData:[['top'],['right'],['left'],['bottom']],mainConfigTitle:desLang.properties,autoLoadData:!0,methodsSearch:!1,useTabs:!0,constructor:function(){this.extraParams={};this.sourceConfig={};this.callParent(arguments)},initComponent:function(){var me=this;this.extraParams.object=this.objectName;var menuStore=app.designer.getMenuStore();this.objectNames={};this.sourceConfig=Ext.apply({'region':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:Ext.create('Ext.data.ArrayStore',{model:'designer.properties.idStringModel',data:this.regionData}),valueField:'id',displayField:'id',allowBlank:!0,forceSelection:!1})},'layout':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:Ext.create('Ext.data.ArrayStore',{model:'designer.properties.idStringModel',data:this.layoutData}),valueField:'id',displayField:'id',allowBlank:!0})},'dock':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:Ext.create('Ext.data.ArrayStore',{model:'designer.properties.idStringModel',data:this.dockData}),valueField:'id',displayField:'id',allowBlank:!0})},'align':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:Ext.create('Ext.data.ArrayStore',{model:'designer.properties.idStringModel',data:this.alignData}),valueField:'id',displayField:'id',allowBlank:!0})},'titleAlign':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:Ext.create('Ext.data.ArrayStore',{model:'designer.properties.idStringModel',data:this.alignData}),valueField:'id',displayField:'id',allowBlank:!0})},'labelAlign':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:Ext.create('Ext.data.ArrayStore',{model:'designer.properties.idStringModel',data:this.labelAlignData}),valueField:'id',displayField:'id',allowBlank:!0})},'iconAlign':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:Ext.create('Ext.data.ArrayStore',{model:'designer.properties.idStringModel',data:this.iconAlignData}),valueField:'id',displayField:'id',allowBlank:!0})},'store':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:me.showStoreWindow,scope:me}}}),renderer:function(v){return'...'}},'menu':{editor:Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!1,queryMode:'remote',displayField:'title',valueField:'id',store:menuStore})},'url':{editor:Ext.create('designer.urlField',{controllerUrl:app.createUrl([designer.controllerUrl,'url','actions','']),listeners:{select:{fn:function(url){me.dataGrid.setProperty('url',url)},scope:me}}})},'icon':{editor:Ext.create('designer.iconField',{controllerUrl:app.createUrl([designer.controllerUrl,'url','']),listeners:{select:{fn:function(url){me.dataGrid.setProperty('icon',url)},scope:me}}})},'controllerUrl':{editor:Ext.create('designer.urlField',{onlyController:!0,controllerUrl:app.createUrl([designer.controllerUrl,'url','actions','']),listeners:{select:{fn:function(url){me.dataGrid.setProperty('controllerUrl',url)},scope:me}}})},'defaults':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:function(){me.showDefaultsWindow('defaults')},scope:me}}}),renderer:function(){return'...'}},'extraParams':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:function(){me.showParamsWindow('extraParams')},scope:me}}}),renderer:function(){return'...'}},'fieldDefaults':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:function(){me.showDefaultsWindow('fieldDefaults')},scope:me}}}),renderer:function(){return'...'}},'isExtended':{editor:Ext.create('Ext.form.field.Display',{})},'dictionary':{editor:Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!1,queryMode:'remote',displayField:'title',valueField:'id',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'listdictionaries',reader:{type:'json',rootProperty:'data',idProperty:'id'},simpleSortMode:!0},remoteSort:!1,autoLoad:!1,sorters:[{property:'title',direction:'DESC'}]})})},'config':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:function(){me.showDefaultsWindow('config')},scope:me}}})},'objectName':{editor:Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!0,queryMode:'local',displayField:'title',valueField:'name',store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'orm','list']),reader:{type:'json',idProperty:'name',rootProperty:'data'}},model:'designer.properties.nameTitleModel',autoLoad:!0,listeners:{scope:me,load:function(store){me.objectNames={};store.each(function(record){me.objectNames[record.get('name')]=record.get('title')},me)}}}),renderer:function(){return'...'}})}},this.sourceConfig);this.searchPanel=Ext.create('SearchPanel',{fieldNames:['name'],local:!0,width:130,hideLabel:!0});this.showCodeBtn=Ext.create('Ext.Button',{scope:me,iconCls:'jsIcon',handler:me.showCode,tooltip:desLang.showCode});this.dataGrid=Ext.create('Ext.grid.property.Grid',{border:!1,region:'center',split:!0,scrollable:!0,title:this.mainConfigTitle,tbar:[this.searchPanel,'->',this.showCodeBtn],sourceConfig:this.sourceConfig,customRenderers:this.customRenderers,nameColumnWidth:150,listeners:{propertychange:{fn:this.onChange,scope:this}},source:{}});this.searchPanel.store=this.dataGrid.getStore();var itemsList=[this.dataGrid];if(this.showEvents){this.eventsPanel=Ext.create('designer.eventsPanel',{title:desLang.events,controllerUrl:this.eventsControllerUrl,objectName:this.objectName,extraParams:this.extraParams,autoLoadData:this.autoLoadData,listeners:{'eventsUpdated':{fn:function(){this.fireEvent('eventsUpdated')},scope:this}}});itemsList.push(this.eventsPanel)}
if(this.showMethods){this.methodsPanel=Ext.create('designer.methodsPanel',{title:desLang.methods,controllerUrl:this.methodsControllerUrl,objectName:this.objectName,extraParams:this.extraParams,autoLoadData:this.autoLoadData,listeners:{'methodsUpdated':{fn:function(){this.fireEvent('methodsUpdated')},scope:this}}});itemsList.push(this.methodsPanel);if(this.methodsSearch){this.methodsPanel.setSearchText(this.methodsSearch);this.methodsSearch=!1}}
if(this.useTabs){this.tabs=Ext.create('Ext.tab.Panel',{items:itemsList});this.items=[this.tabs]}else{this.items=[this.dataGrid]}
itemsList=null;this.callParent();if(this.autoLoadData){this.loadProperties()}},refreshEvents:function(){if(this.showEvents){this.eventsPanel.getStore().proxy.extraParams=this.extraParams;this.eventsPanel.getStore().load()}},refreshMethods:function(){if(this.showMethods){this.methodsPanel.getStore().proxy.extraParams=this.extraParams;this.methodsPanel.getStore().load()}},resetProperties:function(){this.dataGrid.getStore().removeAll()},loadProperties:function(){this.loadRequest=Ext.Ajax.request({url:this.controllerUrl+'list',method:'post',scope:this,params:this.extraParams,success:function(response){response=Ext.JSON.decode(response.responseText);if(response.success){if(!Ext.isEmpty(this.eventsPanel)&&!Ext.isEmpty(this.methodsPanel)){if(!Ext.isEmpty(response.data.isExtended)&&response.data.isExtended){this.eventsPanel.setCanEditLocalEvents(!0);this.methodsPanel.enable()}else{this.eventsPanel.setCanEditLocalEvents(!1);this.methodsPanel.disable()}}
this.dataGrid.setSource(response.data);this.dataGrid.getStore().sort('name','ASC');this.fireEvent('afterLoad',response)}else{this.dataGrid.setSource({})}},failure:function(response){if(response&&!response.aborted){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}}})},setExtraParams:function(params){this.extraParams=Ext.apply(this.extraParams,params)},getExtraParam:function(name){return this.extraParams[name]},getSearchText:function(){if(!Ext.isEmpty(this.searchPanel)&&!Ext.isEmpty(this.searchPanel.searchField)){return this.searchPanel.searchField.getValue()}
return!1},setSearchText:function(text){if(this.searchPanel){this.searchPanel.setValue(text)}},setEventsSearchText:function(text){if(this.eventsPanel){this.eventsPanel.setSearchText(text)}},setMethodsSearchText:function(text){if(this.methodsPanel){this.methodsPanel.setSearchText(text)}else{this.methodsSearch=text}},getEventsSearchText:function(){if(!Ext.isEmpty(this.eventsPanel)){return this.eventsPanel.getSearchText()}
return''},getMethodsSearchText:function(){if(!Ext.isEmpty(this.methodsPanel)){return this.methodsPanel.getSearchText()}
return''},onChange:function(source,recordId,value,oldValue,eOpts){if(value===oldValue){return}
var params=Ext.apply({name:recordId,value:value},this.extraParams);Ext.Ajax.request({url:this.controllerUrl+'setproperty',method:'post',scope:this,params:params,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(!response.success){this.dataGrid.suspendEvents();this.dataGrid.setProperty(recordId,oldValue);this.dataGrid.resumeEvents();var msg=' <br>';if(!Ext.isEmpty(response.msg)){msg+=response.msg}
Ext.Msg.alert(appLang.MESSAGE,desLang.cantSaveProperty+' "'+recordId+'".'+msg)}else{this.fireEvent('dataSaved',recordId,value);designer.msg(desLang.msg,desLang.msg_propertySaved)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},resetSearchField:function(){this.searchPanel.searchField.reset()},showCode:function(){Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'code','objectcode']),method:'post',scope:this,params:{object:this.objectName},success:function(response){response=Ext.JSON.decode(response.responseText);if(!response.success){Ext.Msg.alert(appLang.MESSAGE,response.msg);return}
var editor=Ext.create('designer.codeEditor',{sourceCode:response.data,readOnly:!0});Ext.create('Ext.Window',{title:desLang.sourceCodeFor+' "'+this.objectName+'"',layout:'fit',width:750,height:600,modal:!0,maximizable:!0,items:[editor]}).show()},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},showDefaultsWindow:function(property){var me=this;var source=this.dataGrid.getSource();var data=[];if(!Ext.isEmpty(source[property])){var tmp=Ext.JSON.decode(source[property]);for(var i in tmp){if(typeof tmp[i]!='function'){data.push({'key':i,'value':tmp[i]})}}}
var win=Ext.create('designer.defaultsWindow',{title:property,initialData:data});win.on('dataChanged',function(value){me.dataGrid.setProperty(property,value)},me);Ext.defer(function(){win.show().toFront()},50)},showParamsWindow:function(property){var me=this;var source=this.dataGrid.getSource();var data=[];if(!Ext.isEmpty(source[property])){var tmp=Ext.JSON.decode(source[property]);for(var i in tmp){if(typeof tmp[i]!='function'){data.push({'key':i,'value':tmp[i]})}}}
var win=Ext.create('designer.paramsWindow',{title:property,initialData:data});win.on('dataChanged',function(value){me.dataGrid.setProperty(property,value)},me);Ext.defer(function(){win.show().toFront()},50)},showStoreWindow:function(){var listStore=app.designer.createStoresList(!1);var instanceStore=app.designer.createStoresList(!0);var win=Ext.create('designer.store.PropertyWindow',{title:desLang.store,modal:!0,objectName:this.objectName,columnId:this.extraParams.id,controllerUrl:this.controllerUrl,storesStore:listStore,instancesStore:instanceStore});Ext.defer(function(){win.show().toFront()},50)},destroy:function(){this.showCodeBtn.destroy();if(this.loadRequest&&this.loadRequest.destroy){this.loadRequest.abort();this.loadRequest.destroy()}
this.dataGrid.clearListeners();this.dataGrid.destroy();this.searchPanel.destroy();if(this.methodsPanel){this.methodsPanel.clearListeners();this.methodsPanel.destroy()}
if(this.eventsPanel){this.eventsPanel.clearListeners();this.eventsPanel.destroy()}
Ext.Object.each(this.sourceConfig,function(index,item){if(item.editor&&item.editor.destroy){if(item.getStore){item.getStore().destroy()}
item.editor.destroy()}});this.removeAll(!0,!0);this.callParent(arguments)}});Ext.define('designer.properties.Grid',{extend:'designer.properties.Panel',layout:'accordion',advancedForm:null,initComponent:function(){var me=this;this.mainConfigTitle=desLang.properties;this.tbar=[{iconCls:'gridIcon',tooltip:desLang.columns,scope:me,handler:me.showColumnsWindow}];this.sourceConfig=Ext.apply({'columns':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:this.showColumnsWindow,scope:this}}}),renderer:function(v){return'...'}}});this.advancedForm=Ext.create('Ext.form.Panel',{bodyCls:'formBody',title:desLang.advancedOptions,defaults:{margin:'3 3 3 3'},fieldDefaults:{labelWidth:150},frame:!0,border:!1,scrollable:!0,items:[{xtype:'fieldset',title:desLang.grouping,checkboxName:'grouping',checkboxToggle:!0,collapsed:!0,items:[{name:'groupsummary',fieldLabel:desLang.useGroupSummary,xtype:'checkbox',value:1,uncheckedValue:0},{name:'startCollapsed',fieldLabel:desLang.startCollapsed,xtype:'checkbox',value:1,uncheckedValue:0},{name:'hideGroupedHeader',fieldLabel:desLang.hideGroupedHeader,xtype:'checkbox',value:1,uncheckedValue:0},{name:'enableGroupingMenu',fieldLabel:desLang.enableGroupingMenu,xtype:'checkbox',value:1,uncheckedValue:0},{name:'groupHeaderTpl',fieldLabel:'groupHeaderTpl',xtype:'textfield',anchor:'100%'},{name:'remoteRoot',fieldLabel:'remoteRoot',xtype:'textfield',anchor:'100%'}]},{xtype:'fieldset',checkboxName:'editable',title:desLang.editable,checkboxToggle:!0,collapsed:!0,items:[{fieldLabel:desLang.clicksToEdit,name:'clicksToEdit',xtype:'numberfield',value:1,minValue:1,maxValue:2,width:190,allowDecimals:!1}]},{xtype:'fieldset',checkboxName:'rowexpander',title:desLang.rowExpander,checkboxToggle:!0,collapsed:!0,items:[{fieldLabel:desLang.expanderRowBodyTpl,name:'expander_rowbodytpl',xtype:'textfield',anchor:'100%'}]},{name:'summary',fieldLabel:desLang.useSummary,margin:'0 0 0 15',xtype:'checkbox'},{fieldLabel:desLang.paging,name:'paging',margin:'0 0 0 15',xtype:'checkbox'},{name:'checkboxSelection',fieldLabel:desLang.checkboxSelection,xtype:'checkbox',margin:'0 0 0 15'},{name:'numberedRows',fieldLabel:desLang.numberedRows,xtype:'checkbox',margin:'0 0 0 15'}],buttons:[{text:desLang.save,handler:this.saveAdvancedProperties,scope:this}]});this.callParent();this.add(this.advancedForm);this.advancedForm.load({url:app.createUrl([designer.controllerUrl,'grid','loadadvanced']),params:{object:this.objectName}})},showFiltersWindow:function(){Ext.create('designer.grid.filters.Window',{objectName:this.objectName,listeners:{dataSaved:{fn:function(){this.fireEvent('dataSaved')},scope:this}}}).show()},showColumnsWindow:function(){var win=Ext.create('designer.grid.column.Window',{title:desLang.gridColumnsConfig,objectName:this.objectName});win.show()},saveAdvancedProperties:function(){var handle=this;this.advancedForm.getForm().submit({clientValidation:!0,waitMsg:appLang.SAVING,method:'post',url:app.createUrl([designer.controllerUrl,'grid','setadvanced']),params:{object:this.objectName},success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}else{handle.fireEvent('dataSaved')}},failure:app.formFailure})},destroy:function(){this.advancedForm.destroy();this.callParent(arguments)}});Ext.define('designer.properties.GridColumn',{extend:'designer.properties.Panel',autoLoadData:!1,initComponent:function(){var me=this;this.renderersStore=Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'renderers',reader:{type:'json',rootProperty:'data',idProperty:'id'},extraParams:{object:this.objectName},simpleSortMode:!0},remoteSort:!1,autoLoad:!0,sorters:[{property:'title',direction:'DESC'}]});var summaryEditor=Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!0,queryMode:'local',displayField:'title',valueField:'id',store:this.renderersStore});this.sourceConfig=Ext.apply({'summaryType':{editor:Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!0,queryMode:'local',store:[['count','count'],['sum','sum'],['min','min'],['max','max'],['average','average']]}),renderer:function(v){if(Ext.isEmpty(v)){return'...'}else{return v}}},'summaryRenderer':{editor:summaryEditor,renderer:app.comboBoxRenderer(summaryEditor)},'renderer':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:me.showRendererWindow,scope:me}}}),renderer:function(v){return'...'}},'items':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:me.showItemsWindow,scope:me}}}),renderer:function(v){return'...'}},'filter':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:me.showFilterWindow,scope:me}}}),renderer:function(v){return'...'}}},this.sourceConfig);this.callParent()},showRendererWindow:function(){var win=Ext.create('designer.grid.column.RendererWindow',{title:desLang.renderer,modal:!0,objectName:this.objectName,columnId:this.extraParams.id,controllerUrl:this.controllerUrl});Ext.defer(function(){win.show().toFront()},50)},showItemsWindow:function(){var win=Ext.create('designer.grid.column.ActionsWindow',{title:desLang.items,objectName:this.objectName,columnId:this.extraParams.id,controllerUrl:this.controllerUrl});Ext.defer(function(){win.show().toFront()},50)},showFilterWindow:function(){var win=Ext.create('designer.grid.column.FilterWindow',{title:desLang.filter,objectName:this.objectName,columnId:this.extraParams.id,controllerUrl:this.controllerUrl});Ext.defer(function(){win.show().toFront()},50)},destroy:function(){this.renderersStore.destroy();this.callParent(arguments)}});Ext.define('designer.properties.GridFilter',{extend:'designer.properties.Panel',autoLoadData:!1,initComponent:function(){this.sourceConfig=Ext.apply({'options':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:this.showOptionsWindow,scope:this}}}),renderer:function(v){return'...'}}},this.sourceConfig);this.callParent()},showOptionsWindow:function(){var source=this.dataGrid.getSource();var result=[];var data=[];if(source.options.length){data=Ext.JSON.decode(source.options)}
if(!Ext.isEmpty(data)){Ext.each(data,function(record,index){result.push({value:record})})}
var win=Ext.create('designer.grid.filterOptionsWindow',{objectName:this.objectName,controllerUrl:this.controllerUrl,initialData:result});win.on('dataChanged',this.dataGrid.setProperty,this.dataGrid);win.show()}});Ext.define('designer.properties.dataField',{extend:'designer.properties.Panel',fieldtypes:[['boolean'],['integer'],['float'],['string'],['date']],directions:[['ASC'],['DESC']],initComponent:function(){this.sourceConfig=Ext.apply({'type':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,typeAhead:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',forceSelection:!0,store:Ext.create('Ext.data.ArrayStore',{fields:['id'],data:this.fieldtypes}),valueField:'id',displayField:'id',allowBlank:!0})},'sortDir':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,typeAhead:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',forceSelection:!0,store:Ext.create('Ext.data.ArrayStore',{fields:['id'],data:this.directions}),valueField:'id',displayField:'id',allowBlank:!0})}});this.callParent()}});Ext.define('designer.properties.Store',{extend:'designer.properties.Panel',initComponent:function(){this.tbar=[{iconCls:'fieldIcon',tooltip:desLang.fields,scope:this,handler:this.fieldsHandler},{iconCls:'proxyIcon',tooltip:desLang.proxy,scope:this,handler:this.proxyHandler}];this.mainConfigTitle=desLang.mainConfig;var returnDots=function(v){return'...'};this.sourceConfig=Ext.apply({'proxy':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:this.proxyHandler,scope:this}}}),renderer:returnDots},'sorters':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:this.sortersHandler,scope:this}}}),renderer:returnDots},'filters':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:this.filtersHandler,scope:this}}}),renderer:returnDots},'groupField':{editor:Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!1,queryMode:'remote',queryCaching:!1,displayField:'name',valueField:'name',store:Ext.create('Ext.data.Store',{proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store','listfields']),reader:{type:'json',idProperty:'name',rootProperty:'data'},extraParams:{object:this.objectName},autoLoad:!1},fields:[{name:'name',type:'string'},{name:'type',type:'string'}],autoLoad:!0})})},'fields':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:this.fieldsHandler,scope:this}}}),renderer:returnDots},'model':{editor:Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!1,queryMode:'local',displayField:'title',valueField:'title',store:app.designer.getModelsStore()})}},this.sourceConfig);this.callParent()},proxyHandler:function(){var win=Ext.create('designer.store.proxyWindow',{objectName:this.objectName,maximizable:!0,modal:!0,controllerUrl:app.createUrl([designer.controllerUrl,'storesubproperty',''])});win.on('dataChanged',function(){this.fireEvent('dataSaved')},this);win.show()},sortersHandler:function(){var source=this.dataGrid.getSource();var data=[];var fieldsSet=[];if(source.sorters.length){data=Ext.JSON.decode(source.sorters)}
var win=Ext.create('designer.store.sortersWindow',{objectName:this.objectName,controllerUrl:this.controllerUrl,initialData:data});win.on('dataChanged',this.dataGrid.setProperty,this.dataGrid);win.show()},filtersHandler:function(){var source=this.dataGrid.getSource();var data=[];var fieldsSet=[];if(source.filters.length){data=Ext.JSON.decode(source.filters)}
if(source.fields.length){fieldsSet=Ext.JSON.decode(source.fields)}
var win=Ext.create('designer.store.filtersWindow',{objectName:this.objectName,controllerUrl:this.controllerUrl,initialData:data});win.on('dataChanged',this.dataGrid.setProperty,this.dataGrid);win.show()},fieldsHandler:function(){var source=this.dataGrid.getSource();var data=[];if(source.fields.length){data=Ext.JSON.decode(source.fields)}
var win=Ext.create('designer.store.fieldsWindow',{objectName:this.objectName,controllerUrl:this.controllerUrl,initialData:data});win.on('dataChanged',this.dataGrid.setProperty,this.dataGrid);win.show()}});Ext.define('designer.properties.TreeStore',{extend:'designer.properties.Store',initComponent:function(){var returnDots=function(v){return'...'};this.sourceConfig=Ext.apply({'root':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:this.rootHandler,scope:this}}}),renderer:returnDots}},this.sourceConfig);this.callParent()},rootHandler:function(){var source=this.dataGrid.getSource();var defaultData={text:'',expanded:!1,id:''};var data={};if(source.root.length){data=Ext.JSON.decode(source.root)}
var data=Ext.apply(defaultData,data);var win=Ext.create('designer.store.rootWindow',{objectName:this.objectName,controllerUrl:this.controllerUrl,initialData:data});win.on('dataSaved',function(obj){this.dataGrid.setProperty('root',Ext.JSON.encode(obj))},this);win.show()}});Ext.define('designer.properties.Model',{extend:'designer.properties.Panel',controllerUrl:null,initComponent:function(){this.tbar=[{iconCls:'fieldIcon',tooltip:desLang.fields,scope:this,handler:function(){this.showColumnsWindow(0)}}];var returnDots=function(v){return'...'};this.sourceConfig=Ext.apply({'fields':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:function(){this.showColumnsWindow(0)},scope:this}}}),renderer:returnDots},'associations':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:function(){this.showColumnsWindow(1)},scope:this}}}),renderer:returnDots},'validators':{editor:Ext.create('Ext.form.field.Text',{listeners:{focus:{fn:function(){this.showColumnsWindow(2)},scope:this}}}),renderer:returnDots}},this.sourceConfig);this.callParent()},showColumnsWindow:function(activeTab){var source=this.dataGrid.getSource();var associations=[];var fields=[];var validators=[];if(source.associations.length){associations=Ext.JSON.decode(source.associations)}
if(source.fields.length){fields=Ext.JSON.decode(source.fields)}
if(source.validators.length){validators=Ext.JSON.decode(source.validators)}
var win=Ext.create('designer.model.configWindow',{objectName:this.objectName,controllerUrl:this.controllerUrl,activeTab:activeTab,initFields:fields,initAssociations:associations,initValidators:validators});win.on('dataChanged',function(fields,associations,validators){this.dataGrid.setProperty('associations',associations,!0);this.dataGrid.setProperty('validators',validators,!0)},this);win.show()}});Ext.define('designer.properties.FieldTypeWindow',{extend:'Ext.Window',objectName:'',width:300,height:150,resizable:!1,modal:!0,setupForm:null,layout:'fit',controllerUrl:'',title:desLang.changeFieldType,constructor:function(){this.extraParams={};this.callParent(arguments)},initComponent:function(){this.setupForm=Ext.create('Ext.form.Panel',{region:'north',bodyCls:'formBody',border:!1,autoHeight:!0,fieldDefaults:{labelAlign:'left',anchor:'100%',labelWidth:150},defaults:{xtype:'textfield',margin:'3 3 3 3 '},items:[{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,fieldLabel:desLang.type,labelWidth:80,name:'type',forceSelection:!0,store:[['Form_Field_Checkbox','Checkbox'],['Form_Field_Combobox','Combobox'],['Form_Field_File','File'],['Form_Field_Hidden','Hidden'],['Form_Field_Htmleditor','Htmleditor'],['Form_Field_Number','Number'],['Form_Field_Radio','Radio'],['Form_Field_Text','Text'],['Form_Field_Textarea','Textarea'],['Form_Field_Time','Time'],['Form_Field_Date','Date'],['Form_Fieldset','Fieldset'],['Form_Field_Display','Display'],['Form_Fieldcontainer','Fieldcontainer'],['Form_Checkboxgroup','CheckboxGroup'],['Form_Radiogroup','Radiogroup'],['Form_Field_Adapter','Adapter']],listeners:{select:function(field,value,options){this.onTypeSelected(field.getValue())},scope:this}},{hidden:!0,name:'adapter',xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,fieldLabel:desLang.adapter,labelWidth:80,matchFieldWidth:!1,forceSelection:!0,valueField:'id',displayField:'title',qyeryMode:'local',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'listadapters',reader:{type:'json',rootProperty:'data',idProperty:'id'},simpleSortMode:!0},remoteSort:!1,autoLoad:!0,sorters:[{property:'title',direction:'DESC'}]}),listeners:{select:function(field,value,options){this.onAdapterSelected(field.getValue())},scope:this}},{hidden:!0,name:'dictionary',xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,fieldLabel:desLang.dictionary,labelWidth:80,forceSelection:!0,valueField:'id',displayField:'title',qyeryMode:'local',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'listdictionaries',reader:{type:'json',rootProperty:'data',idProperty:'id'},simpleSortMode:!0},remoteSort:!1,autoLoad:!0,sorters:[{property:'title',direction:'DESC'}]})}]});this.items=[this.setupForm];this.buttons=[{text:desLang.save,scope:this,handler:this.saveType},{text:desLang.close,scope:this,handler:this.close}];this.callParent()},onTypeSelected:function(type){var form=this.setupForm.getForm();if(type=='Form_Field_Adapter'){form.findField('adapter').show()}else{form.findField('adapter').hide();form.findField('dictionary').hide()}},onAdapterSelected:function(adapter){var form=this.setupForm.getForm();if(adapter=='Ext_Component_Field_System_Dictionary'){form.findField('dictionary').show()}else{form.findField('dictionary').hide()}},saveType:function(){var type=this.setupForm.getForm().findField('type').getValue();if(type==='Form_Field_Adapter'){var adapter=this.setupForm.getForm().findField('adapter').getValue();if(!adapter){Ext.Msg.alert(appLang.MESSAGE,desLang.selectAdapter);return}
if(adapter==='Ext_Component_Field_System_Dictionary'){var dictionary=this.setupForm.getForm().findField('dictionary').getValue();if(!dictionary){Ext.Msg.alert(appLang.MESSAGE,desLang.selectDictionary);return}}}
var me=this;var params=Ext.apply(this.extraParams,{'object':this.objectName});this.setupForm.getForm().submit({clientValidation:!0,waitMsg:appLang.SAVING,method:'post',url:this.controllerUrl+'changetype',params:params,success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}else{me.fireEvent('objectsUpdated');me.close()}},failure:app.formFailure})}});Ext.define('designer.properties.Field',{extend:'designer.properties.Panel',constructor:function(){this.tbar=[];this.callParent(arguments)},initComponent:function(){this.tbar.push({text:desLang.changeFieldType,scope:this,handler:this.selectType});this.callParent()},selectType:function(){Ext.create('designer.properties.FieldTypeWindow',{objectName:this.objectName,controllerUrl:this.controllerUrl,extraParams:this.extraParams,listeners:{'objectsUpdated':{fn:function(){this.fireEvent('objectsUpdated');this.loadProperties()},scope:this}}}).show()}});Ext.define('designer.properties.Window',{extend:'designer.properties.Panel',initComponent:function(){if(!this.tbar){this.tbar=[]}
this.tbar.push({icon:app.wwwRoot+'i/system/designer/window-open.png',text:desLang.showWindow,scope:this,handler:this.showWindow});this.callParent()},showWindow:function(){app.designer.switchView(0);app.designer.sendCommand({command:'showWindow',params:{name:this.objectName}})}});Ext.define('designer.properties.CrudWindow',{extend:'designer.properties.Window',initComponent:function(){var me=this;if(!this.tbar){this.tbar=[]}
this.tbar.push({iconCls:'importOrmIcon',tooltip:desLang.importOrm,scope:this,handler:this.showImportFromOrm});this.callParent()},showImportFromOrm:function(){this.importWindow=Ext.create('designer.ormSelectorWindow',{listeners:{select:{fn:this.importFields,scope:this}}});this.importWindow.show()},importFields:function(object,fields){this.importWindow.close();Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'crudwindow','importfields']),method:'post',scope:this,params:{'object':this.objectName,'importobject':object,'importfields[]':fields},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.application.onChange()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})}});Ext.define('designer.properties.Form',{extend:'designer.properties.Panel',importWindow:null,initComponent:function(){this.tbar=[{iconCls:'importOrmIcon',tooltip:desLang.importOrm,scope:this,handler:this.showImportFromOrm},{iconCls:'importDbIcon',tooltip:desLang.importDb,scope:this,handler:this.showImportFromDb}];this.callParent()},showImportFromOrm:function(){this.importWindow=Ext.create('designer.ormSelectorWindow',{listeners:{select:{fn:this.importFields,scope:this}}});this.importWindow.show()},showImportFromDb:function(){this.importWindow=Ext.create('designer.importDBWindow',{listeners:{select:{fn:this.importDbFields,scope:this}}});this.importWindow.show()},importFields:function(object,fields){this.importWindow.close();Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'form','importfields']),method:'post',scope:this,params:{'object':this.objectName,'importobject':object,'importfields[]':fields},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.fireEvent('objectsUpdated')}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},importDbFields:function(fields,connection,table,contype){this.importWindow.close();Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'form','importdbfields']),method:'post',scope:this,params:{'object':this.objectName,'connection':connection,'table':table,'type':contype,'importfields[]':fields},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.fireEvent('objectsUpdated')}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})}});Ext.define('designer.properties.GridEditor',{extend:'designer.properties.Field',columnName:null,initComponent:function(){this.tbar.push({text:desLang.removeEditor,scope:this,handler:this.removeEditor,iconCls:'deleteIcon'});this.setExtraParams({column:this.columnName});this.callParent(arguments)},removeEditor:function(){Ext.Ajax.request({url:this.controllerUrl+'remove',method:'post',scope:this,params:this.extraParams,success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataGrid.setSource({});this.fireEvent('editorRemoved',response)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}});this.fireEvent('editorRemoved')}});Ext.define('designer.properties.FilterComponent',{extend:'designer.properties.Panel',layout:'accordion',fieldProperties:null,initComponent:function(){this.eventsControllerUrl=app.createUrl([designer.controllerUrl,'filterEvents','']);this.mainConfigTitle=desLang.properties;this.fieldsStore=Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',url:this.controllerUrl+'storefields',reader:{type:'json',rootProperty:'data',idProperty:'id'},extraParams:{object:this.objectName},simpleSortMode:!0},remoteSort:!1,autoLoad:!0,sorters:[{property:'id',direction:'ASC'}]});this.sourceConfig=Ext.apply({'storeField':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'remote',store:this.fieldsStore,valueField:'id',displayField:'id',allowBlank:!0,forceSelection:!1})},'type':{editor:Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!0,queryMode:'local',store:[['Component',desLang.component],['Field',desLang.field]]})}});var me=this;this.callParent();this.fieldProperties=Ext.create('designer.properties.Field',{title:desLang.advancedOptions,controllerUrl:app.createUrl([designer.controllerUrl,'filter','']),objectName:this.objectName,application:me,showEvents:!1});this.fieldProperties.on('dataSaved',function(){this.fireEvent('dataSaved')},this);this.fieldProperties.on('objectsUpdated',function(){this.fireEvent('objectsUpdated')},this);this.add(this.fieldProperties)},destroy:function(){this.fieldsStore.destroy();this.fieldProperties.destroy();this.callParent(arguments)}});Ext.define('designer.properties.Search',{extend:'designer.properties.Field',initComponent:function(){var me=this;this.sourceConfig=Ext.apply({'fieldNames':{editor:Ext.create('Ext.form.field.Text',{listeners:{'focus':{fn:me.namesEdior,scope:me}}}),renderer:function(v){return'...'}}},this.sourceConfig);this.callParent()},namesEdior:function(){var storeProperty=this.dataGrid.getSource().store;var fieldsList=this.dataGrid.getSource().fieldNames;if(fieldsList.length){fieldsList=Ext.JSON.decode(fieldsList)}else{fieldsList=[]}
if(!storeProperty.length){Ext.Msg.alert(appLang.MESSAGE,desLang.selectDataStore);return}
Ext.create('designer.properties.SearchFieldsWindow',{fieldsStore:storeProperty,initData:fieldsList,listeners:{dataChanged:{fn:function(data){this.dataGrid.setProperty('fieldNames',data);this.fireEvent('dataChanged')},scope:this}}}).show()}});Ext.define('designer.properties.SearchFieldsWindow',{extend:'Ext.Window',width:200,height:300,title:'fieldNames',initData:null,dataGrid:null,dataStore:null,fieldsStore:null,closeAction:'destroy',resizable:!1,layout:'fit',storeName:'',initComponent:function(){if(Ext.isEmpty(this.initData)){this.initData=[]}else{var data=[];Ext.each(this.initData,function(item){data.push([item])},this);this.initData=data}
this.dataStore=Ext.create('Ext.data.ArrayStore',{fields:['id'],data:this.initData}),this.fieldStore=Ext.create('Ext.data.Store',{proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store','listfields']),reader:{type:'json',idProperty:'name',rootProperty:'data'},extraParams:{object:this.fieldsStore},autoLoad:!0},fields:[{name:'name',type:'string'},{name:'type',type:'string'}],autoLoad:!0});this.tbar=[{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addRecord}];this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.dataGrid=Ext.create('Ext.grid.Panel',{store:this.dataStore,columnLines:!0,hideHeaders:!0,columns:[{dataIndex:'id',editable:!0,flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,store:this.fieldStore,displayField:'name',valueField:'name',allowBlank:!1,queryMode:'local'}},{xtype:'actioncolumn',width:25,align:'center',sortable:!1,menuDisabled:!0,items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();store.remove(store.getAt(row))}}]}],plugins:[this.cellEditing]});this.items=[this.dataGrid];this.buttons=[{text:desLang.save,handler:this.sendData,scope:this},{text:desLang.close,handler:this.close,scope:this}];this.callParent()},sendData:function(){var data=[];this.dataStore.each(function(record){var name=record.get('id');if(name.length){data.push(record.get('id'))}},this);data=Ext.JSON.encode(data);this.fireEvent('dataChanged',data);this.close()},addRecord:function(){var count=this.dataStore.getCount();var r=[''];this.dataStore.insert(count,r);this.cellEditing.startEditByPosition({row:count,column:0})}});Ext.define('designer.properties.MediaItem',{extend:'designer.properties.Field',initComponent:function(){this.sourceConfig=Ext.apply({'resourceType':{editor:Ext.create('Ext.form.ComboBox',{selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',store:app.medialib.typesStore,valueField:'id',displayField:'title',allowBlank:!0})}});this.callParent()}});Ext.ns('designer.model');Ext.define('designer.model.fieldsModel',{extend:'Ext.data.Model',fields:[{name:'name',type:'string'},{name:'type',type:'string'}],idProperty:'name'});Ext.define('designer.model.associationsModel',{extend:'Ext.data.Model',fields:[{name:'field',type:'string'},{name:'model',type:'string'},{name:'type',type:'string'}],idProperty:'field'});Ext.define('designer.model.validationsModel',{extend:'Ext.data.Model',fields:[{name:'field',type:'string'},{name:'type',type:'string'}],idProperty:'field'});Ext.define('designer.model.configWindow',{extend:'Ext.Window',width:600,height:600,layout:'fit',tabPanel:null,activeTab:0,modal:!0,title:desLang.modelConfig,objectName:null,controllerUrl:null,fieldsGrid:null,fieldsStore:null,initFields:[],initAssociations:[],initValidators:[],fieldsCellEditing:null,initFieldsEditor:function(){var me=this;this.fieldsStore=Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.model.fieldsModel',autoLoad:!0,proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'model','listfields']),extraParams:{object:this.objectName},reader:{idProperty:"name",rootProperty:"data",type:"json"}}});this.fieldsProperties=Ext.create('designer.properties.dataField',{controllerUrl:app.createUrl([designer.controllerUrl,'datafield','']),objectName:this.objectName,autoLoadData:!1,autoLoad:!1,title:desLang.properties,layout:'fit',region:'east',showEvents:!1,split:!0,width:250});this.fieldsCellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.fieldsGrid=Ext.create('Ext.grid.Panel',{region:'center',store:this.fieldsStore,columnLines:!0,columns:[{text:desLang.field,dataIndex:'name',flex:1,editor:{xtype:'textfield',vtype:'alphanum',allowBlank:!1}},{text:desLang.type,dataIndex:'type',flex:1,editor:{xtype:'combobox',typeAhead:!0,selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',forceSelection:!0,displayField:'id',valueField:'id',store:Ext.create('Ext.data.ArrayStore',{fields:['id'],data:this.fieldsProperties.fieldtypes})}},{xtype:'actioncolumn',width:25,sortable:!1,menuDisabled:!0,align:'center',items:[{iconCls:'deleteIcon',tooltip:desLang.remove,scope:me,handler:function(grid,row,col){var store=grid.getStore();me.removeField(store.getAt(row))}}]}],plugins:[this.fieldsCellEditing],tbar:[{iconCls:'importOrmIcon',tooltip:desLang.importOrm,scope:this,handler:this.importFromOrm},{iconCls:'importDbIcon',tooltip:desLang.importDb,scope:this,handler:this.importFromDb},{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addField}],listeners:{scope:this,edit:function(editor,o){this.fieldsProperties.dataGrid.setProperty(o.field,o.value);this.fieldsStore.commitChanges();if(o.field==='name'){this.fieldsProperties.setExtraParams({'id':o.value})}}}});this.fieldsGrid.getSelectionModel().on('selectionchange',function(sm,data,opts){this.fieldsCellEditing.cancelEdit();if(!sm.hasSelection()){this.fieldsProperties.resetProperties();this.fieldsProperties.refreshEvents();return}
this.fieldsProperties.setExtraParams({'id':sm.getSelection()[0].get('name')});this.fieldsProperties.loadProperties()},this);this.fieldsProperties.dataGrid.on('propertychange',function(source,recordId,value){if(recordId==='name'||recordId==='type'){var sm=this.fieldsGrid.getSelectionModel();if(sm.hasSelection()){var record=sm.getLastSelected();record.beginEdit();record.set(recordId,value);record.endEdit();record.commit();this.fireEvent('dataChanged')}}},this);this.fieldsEditor=Ext.create('Ext.Panel',{title:desLang.fields,layout:'border',frame:!1,items:[this.fieldsGrid,this.fieldsProperties]});return this.fieldsEditor},initComponent:function(){var me=this;this.initFieldsEditor();this.associationsGrid=Ext.create('Ext.grid.Panel',{title:desLang.associations,store:Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.model.associationsModel',autoLoad:!1,data:this.initAssociations}),columns:[{text:desLang.field,dataIndex:'field',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',queryMode:'local',selectOnTab:!0,valueField:'name',displayField:'name',forceSelection:!0,store:me.fieldsStore}},{text:desLang.type,dataIndex:'type',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,store:[['hasMany','Has Many'],['belongsTo','Belongs To']]}},{text:desLang.model,dataIndex:'model',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',queryMode:'local',selectOnTab:!0,valueField:'id',displayField:'id',forceSelection:!0,store:app.designer.getModelsStore()}},{xtype:'actioncolumn',width:25,align:'center',sortable:!1,menuDisabled:!0,items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();store.remove(store.getAt(row))}}]}],plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],tbar:[{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addAssociation}]});this.validationsGrid=Ext.create('Ext.grid.Panel',{title:desLang.validators,store:Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.model.validationsModel',autoLoad:!1,data:this.initValidators}),columns:[{text:desLang.field,dataIndex:'field',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',queryMode:'local',selectOnTab:!0,valueField:'name',displayField:'name',forceSelection:!0,store:this.fieldsStore}},{text:desLang.type,dataIndex:'type',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,store:[['alpha','alpha'],['alphanum','alphanum'],['email','email'],['url','url']]}},{xtype:'actioncolumn',width:25,align:'center',sortable:!1,menuDisabled:!0,items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();store.remove(store.getAt(row))}}]}],plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],tbar:[{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addValidation}]});this.tabPanel=Ext.create('Ext.tab.Panel',{activeTab:this.activeTab,layout:'fit',defaults:{layout:'fit',scrollable:!0},items:[this.fieldsEditor,this.associationsGrid,this.validationsGrid]});this.buttons=[{text:desLang.save,handler:this.saveData,scope:this},{text:desLang.close,scope:this,handler:this.close}];this.items=[this.tabPanel];this.callParent(arguments)},importFromOrm:function(){var win=Ext.create('designer.ormSelectorWindow',{});win.on('select',function(objectName,fields){this.setLoading(!0);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'model',''])+'importormfields/',method:'post',scope:this,params:{object:this.objectName,objectName:objectName,'fields[]':fields},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.fieldsStore.load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
this.setLoading(!1)},failure:function(){this.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this);win.show()},importFromDb:function(){var win=Ext.create('designer.importDBWindow',{title:desLang.importDb});win.on('select',function(fields,connectionId,table,contype){this.setLoading(!0);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'model',''])+'importdbfields/',method:'post',scope:this,params:{object:this.objectName,'fields[]':fields,connectionId:connectionId,table:table,type:contype},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.fieldsStore.load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
this.setLoading(!1)},failure:function(){this.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this);win.show()},fieldsHasDirtyRecords:function(){var has=!1;this.fieldsStore.each(function(record){if(record.dirty||record.phantom){has=!0}},this);return has},addField:function(){var me=this;Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterFieldName,function(btn,text){if(btn!='ok'){return}
me.setLoading(!0);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'model','addfield']),method:'post',scope:me,params:{object:me.objectName,id:text},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){var rec;var item=response.data;rec=Ext.create('designer.model.fieldsModel',{name:item.name,type:item.type});me.fieldsStore.add(rec)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
me.setLoading(!1)},failure:function(){me.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})})},removeField:function(record){var me=this;Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'model','removefield']),method:'post',scope:me,params:{object:me.objectName,id:record.get('name')},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.fieldsStore.remove(record)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
me.setLoading(!1)},failure:function(){me.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},addAssociation:function(){var store=this.associationsGrid.getStore();var count=store.getCount();var r=Ext.create('designer.model.associationsModel',{});store.insert(count,r);this.associationsGrid.getPlugin().startEditByPosition({row:count,column:0})},addValidation:function(){var store=this.validationsGrid.getStore();var count=store.getCount();var r=Ext.create('designer.model.validationsModel',{});store.insert(count,r);this.validationsGrid.getPlugin().startEditByPosition({row:count,column:0})},saveData:function(){this.associationsGrid.getStore().commitChanges();this.validationsGrid.getStore().commitChanges();this.fireEvent('dataChanged','',Ext.encode(app.collectStoreData(this.associationsGrid.getStore())),Ext.encode(app.collectStoreData(this.validationsGrid.getStore())))}});Ext.ns('designer.store');Ext.define('designer.store.sortersModel',{extend:'Ext.data.Model',fields:[{name:'property',type:'string'},{name:'direction',type:'string'}],idProperty:'property'});Ext.define('designer.store.filtersModel',{extend:'Ext.data.Model',fields:[{name:'property',type:'string'},{name:'value',type:'string'}],idProperty:'property'});Ext.define('designer.store.fieldsModel',{extend:'Ext.data.Model',fields:[{name:'name',type:'string'},{name:'type',type:'string'}],idProperty:'name'});Ext.define('designer.store.sortersWindow',{extend:'Ext.Window',width:500,height:300,layout:'fit',modal:!0,title:desLang.sorters,dataGrid:null,dataStore:null,initialData:[],cellEditing:null,objectName:null,controllerUrl:null,initComponent:function(){this.tbar=[{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addRecord}];this.dataStore=Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.store.sortersModel',autoLoad:!1,data:this.initialData});this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.dataGrid=Ext.create('Ext.grid.Panel',{columnLines:!0,autoHeight:!0,store:this.dataStore,columns:[{text:desLang.field,dataIndex:'property',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',queryMode:'local',selectOnTab:!0,valueField:'name',displayField:'name',forceSelection:!0,store:Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.store.fieldsModel',proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store','allfields']),reader:{type:'json',idProperty:'name',rootProperty:'data'},extraParams:{object:this.objectName},autoLoad:!0},sorters:[{property:'name',direction:'ASC'}],autoLoad:!0})}},{text:desLang.direction,dataIndex:'direction',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,store:[['ASC','ASC'],['DESC','DESC']]}},{xtype:'actioncolumn',width:25,align:'center',sortable:!1,menuDisabled:!0,items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();store.remove(store.getAt(row))}}]}],plugins:[this.cellEditing]});this.items=[this.dataGrid];this.buttons=[{text:desLang.save,handler:this.saveData,scope:this},{text:desLang.close,handler:function(){this.close()},scope:this}];this.callParent(arguments)},addRecord:function(){var count=this.dataStore.getCount();var r=Ext.create('designer.store.sortersModel',{field:'',direction:'ASC'});this.dataStore.insert(count,r);this.cellEditing.startEditByPosition({row:count,column:0})},saveData:function(){this.dataStore.commitChanges();this.fireEvent('dataChanged','sorters',Ext.encode(app.collectStoreData(this.dataStore)),!0)}});Ext.define('designer.store.filtersWindow',{extend:'Ext.Window',width:500,height:300,layout:'fit',modal:!0,title:desLang.filters,dataGrid:null,dataStore:null,initialData:[],cellEditing:null,objectName:null,controllerUrl:null,initComponent:function(){this.tbar=[{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addRecord}];this.dataStore=Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.store.filtersModel',data:this.initialData,autoLoad:!1});this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.dataGrid=Ext.create('Ext.grid.Panel',{columnLines:!0,autoHeight:!0,store:this.dataStore,columns:[{text:desLang.field,dataIndex:'property',flex:1,editor:{xtype:'combobox',typeAhead:!0,triggerAction:'all',queryMode:'local',selectOnTab:!0,valueField:'name',displayField:'name',forceSelection:!0,store:Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.store.fieldsModel',proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store','allfields']),reader:{type:'json',idProperty:'name',rootProperty:'data'},extraParams:{object:this.objectName},autoLoad:!0},autoLoad:!0,sorters:[{property:'name',direction:'ASC'}]})}},{text:desLang.value,dataIndex:'value',flex:1,editor:{xtype:'textfield'}},{xtype:'actioncolumn',width:25,sortable:!1,menuDisabled:!0,align:'center',items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();store.remove(store.getAt(row))}}]}],plugins:[this.cellEditing]});this.items=[this.dataGrid];this.buttons=[{text:desLang.save,handler:this.saveData,scope:this},{text:desLang.cancel,handler:function(){this.close()},scope:this}];this.callParent(arguments)},addRecord:function(){var count=this.dataStore.getCount();var r=Ext.create('designer.store.filtersModel',{property:'',value:''});this.dataStore.insert(count,r);this.cellEditing.startEditByPosition({row:count,column:0})},saveData:function(){this.dataStore.commitChanges();this.fireEvent('dataChanged','filters',Ext.encode(app.collectStoreData(this.dataStore)),!0)}});Ext.define('designer.store.fieldsWindow',{extend:'Ext.Window',width:600,height:500,modal:!0,title:desLang.fields,dataGrid:null,dataStore:null,initialData:[],cellEditing:null,objectName:null,controllerUrl:null,propertiesPanel:null,layout:'border',initComponent:function(){var me=this;this.tbar=[{iconCls:'importOrmIcon',tooltip:desLang.importOrm,scope:this,handler:this.importFromOrm},{iconCls:'importDbIcon',tooltip:desLang.importDb,scope:this,handler:this.importFromDb},{tooltip:desLang.add,iconCls:'plusIcon',scope:this,handler:this.addRecord}];this.dataStore=Ext.create('Ext.data.Store',{autoDestroy:!0,model:'designer.store.fieldsModel',autoLoad:!0,proxy:{type:'ajax',url:app.createUrl([designer.controllerUrl,'store','listfields']),extraParams:{object:this.objectName},reader:{idProperty:"name",rootProperty:"data",type:"json"}},sorters:[{property:'name',direction:'ASC'}]});this.cellEditing=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});this.propertiesPanel=Ext.create('designer.properties.dataField',{controllerUrl:app.createUrl([designer.controllerUrl,'datafield','']),objectName:this.objectName,autoLoadData:!1,autoLoad:!1,title:desLang.properties,layout:'fit',region:'east',showEvents:!1,split:!0,width:250});this.dataGrid=Ext.create('Ext.grid.Panel',{region:'center',columnLines:!0,autoHeight:!0,store:this.dataStore,columns:[{text:desLang.field,dataIndex:'name',flex:1,editor:{xtype:'textfield',vtype:'alphanum',allowBlank:!1}},{text:desLang.type,dataIndex:'type',flex:1,editor:{xtype:'combobox',typeAhead:!0,selectOnFocus:!0,editable:!0,triggerAction:'all',anchor:'100%',queryMode:'local',forceSelection:!0,displayField:'id',valueField:'id',store:Ext.create('Ext.data.ArrayStore',{fields:['id'],data:this.propertiesPanel.fieldtypes})}},{xtype:'actioncolumn',width:25,sortable:!1,menuDisabled:!0,align:'center',items:[{iconCls:'deleteIcon',tooltip:desLang.remove,handler:function(grid,row,col){var store=grid.getStore();me.removeField(store.getAt(row))}}]}],plugins:[this.cellEditing],listeners:{scope:this,edit:function(editor,o){this.propertiesPanel.dataGrid.setProperty(o.field,o.value);this.dataStore.commitChanges();if(o.field==='name'){this.propertiesPanel.setExtraParams({'id':o.value})}}}});this.items=[this.dataGrid,this.propertiesPanel];this.callParent(arguments);this.dataGrid.getSelectionModel().on('selectionchange',function(sm,data,opts){this.cellEditing.cancelEdit();if(!sm.hasSelection()){this.propertiesPanel.resetProperties();this.propertiesPanel.refreshEvents();return}
this.propertiesPanel.setExtraParams({'id':sm.getSelection()[0].get('name')});this.propertiesPanel.loadProperties()},this);this.propertiesPanel.dataGrid.on('propertychange',function(source,recordId,value){if(recordId==='name'||recordId==='type'){var storeRecordId=this.propertiesPanel.extraParams.id;var index=this.dataGrid.getStore().findExact('name',storeRecordId);if(index!=-1){var record=this.dataGrid.getStore().getAt(index);if(record.get(recordId)!==value){record.set(recordId,value);record.commit();this.fireEvent('dataChanged')}}}},this)},importFromDb:function(){var win=Ext.create('designer.importDBWindow',{title:desLang.importDb});win.on('select',function(fields,connectionId,table,contype){this.setLoading(!0);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'store',''])+'importdbfields/',method:'post',scope:this,params:{object:this.objectName,'fields[]':fields,connectionId:connectionId,table:table,type:contype},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
this.setLoading(!1)},failure:function(){this.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this);win.show()},removeField:function(record){var me=this;Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'store','removefield']),method:'post',scope:me,params:{object:me.objectName,id:record.get('name')},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.dataStore.remove(record)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
me.setLoading(!1)},failure:function(){me.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},hasDirtyRecords:function(){var has=!1;this.dataStore.each(function(record){if(record.dirty||record.phantom){has=!0}},this);return has},addRecord:function(){var me=this;Ext.MessageBox.prompt(appLang.MESSAGE,desLang.enterFieldName,function(btn,text){if(btn!='ok'){return}
me.setLoading(!0);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'store','addfield']),method:'post',scope:me,params:{object:me.objectName,id:text},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){var rec;var item=response.data;rec=Ext.create('designer.store.fieldsModel',{name:item.name,type:item.type});me.dataStore.add(rec)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
me.setLoading(!1)},failure:function(){me.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})})},importFromOrm:function(){var win=Ext.create('designer.ormSelectorWindow',{});win.on('select',function(objectName,fields){this.setLoading(!0);Ext.Ajax.request({url:app.createUrl([designer.controllerUrl,'store',''])+'importormfields/',method:'post',scope:this,params:{object:this.objectName,objectName:objectName,'fields[]':fields},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}
this.setLoading(!1)},failure:function(){this.setLoading(!1);Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},this);win.show()},destroy:function(){this.dataStore.destroy();this.dataGrid.destroy();this.cellEditing.destroy();this.propertiesPanel.destroy();this.callParent(arguments)}});Ext.define('designer.store.proxyWindow',{extend:'Ext.Window',width:500,height:500,layout:'border',title:desLang.proxy,dataGrid:null,objectName:null,controllerUrl:null,proxyProperties:null,proxyPropertiesContainer:null,initComponent:function(){this.proxyPropertiesContainer=Ext.create('Ext.panel.Panel',{region:'east',width:300,split:!0,layout:'fit'});this.dataGrid=Ext.create('Ext.grid.Panel',{region:'center',split:!0,title:appLang.proxyConfig,store:Ext.create('Ext.data.Store',{model:'app.comboValueModel',proxy:{url:this.controllerUrl+'proplist',extraParams:{object:this.objectName},type:'ajax',reader:{type:'json',rootProperty:'data',idProperty:'id'}},autoLoad:!0}),columns:[{text:desLang.name,dataIndex:'name',renderer:function(value){switch(value){case 'proxy':return desLang.proxyConfig;break;case 'reader':return desLang.proxyReader;break;case 'writer':return desLang.proxyWriter;break}
return value},flex:1}]});this.dataGrid.getSelectionModel().on('select',function(rowModel,record,index){this.typeSelected(record)},this);this.callParent();this.add([this.dataGrid,this.proxyPropertiesContainer])},typeSelected:function(rec){this.proxyPropertiesContainer.removeAll();switch(rec.get('name')){case 'proxy':this.proxyProperties=Ext.create('designer.properties.Panel',{controllerUrl:this.controllerUrl,objectName:this.objectName,showEvents:!1,extraParams:{sub:'proxy'},tbar:[desLang.type,' ',{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,value:rec.get('value'),displayField:'title',valueField:'id',queryMode:'local',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',reader:{type:'json'}},data:[{id:'ajax',title:'Ajax'},{id:'jsonp',title:'JsonP'},{id:'direct',title:'Direct'},{id:'memory',title:'Memory'},{id:'rest',title:'Rest'},{id:'sessionstorage',title:'Session Storage'},{id:'localstorage',title:'Local Storage'}],autoLoad:!1}),listeners:{select:{fn:function(field){this.changeType('proxy',field.getValue())},scope:this}}}]});this.proxyPropertiesContainer.add(this.proxyProperties);break;case 'reader':this.proxyProperties=Ext.create('designer.properties.Panel',{controllerUrl:this.controllerUrl,objectName:this.objectName,showEvents:!1,extraParams:{sub:'reader'},tbar:[desLang.type,' ',{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,value:rec.get('value'),displayField:'title',valueField:'id',queryMode:'local',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',reader:{type:'json'}},data:[{id:'array',title:'Array'},{id:'json',title:'JSON'},{id:'xml',title:'XML'}],autoLoad:!1}),listeners:{select:{fn:function(field){this.changeType('reader',field.getValue())},scope:this}}}]});this.proxyPropertiesContainer.add(this.proxyProperties);break;case 'writer':this.proxyProperties=Ext.create('designer.properties.Panel',{controllerUrl:this.controllerUrl,objectName:this.objectName,showEvents:!1,extraParams:{sub:'writer'},tbar:[desLang.type,' ',{xtype:'combobox',typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,value:rec.get('value'),displayField:'title',valueField:'id',queryMode:'local',store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',proxy:{type:'ajax',reader:{type:'json'}},data:[{id:'json',title:'JSON'},{id:'xml',title:'XML'}],autoLoad:!1}),listeners:{select:{fn:function(field){this.changeType('writer',field.getValue())},scope:this}}}]});this.proxyPropertiesContainer.add(this.proxyProperties);break}
this.proxyProperties.updateLayout();this.proxyProperties.dataGrid.getStore().on('load',function(store){store.remove('type')},this)},changeType:function(sub,value){Ext.Ajax.request({url:this.controllerUrl+'changetype',method:'post',scope:this,params:{object:this.objectName,sub:sub,type:value},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.proxyProperties.loadProperties();this.dataGrid.getStore().load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},destroy:function(){this.dataGrid.getStore().destroy();this.dataGrid.destroy();this.proxyPropertiesContainer.destroy();this.callParent(arguments)}});Ext.define('designer.store.rootWindow',{extend:'Ext.Window',width:500,height:500,layout:'fit',modal:!0,title:'root',dataGrid:null,objectName:null,controllerUrl:null,initialData:null,initComponent:function(){this.dataGrid=Ext.create('Ext.grid.property.Grid',{border:!1,scrollable:!0,nameColumnWidth:150,source:this.initialData});this.items=[this.dataGrid];this.buttons=[{text:desLang.save,scope:this,handler:this.onDataSaved},{text:desLang.cancel,scope:this,handler:this.close}];this.callParent()},onDataSaved:function(){this.fireEvent('dataSaved',this.dataGrid.getSource());this.close()},destroy:function(){this.dataGrid.destroy();this.callParent(arguments)}});Ext.define('designer.store.PropertyWindow',{extend:'Ext.Window',layout:'fit',objectName:'',columnId:'',controllerUrl:'',width:400,height:500,maximizable:!0,modal:!0,storesStore:null,instancesStore:null,initComponent:function(){var me=this;this.storesStore.load();this.instancesStore.load();this.storeSelect=Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,queryMode:'local',displayField:'title',valueField:'id',fieldLabel:desLang.store,store:this.storesStore,hidden:!0,name:'store'});this.instanceSelect=Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,forceSelection:!0,queryMode:'local',displayField:'title',valueField:'id',fieldLabel:desLang.instanceOf+' '+desLang.store,store:this.instancesStore,hidden:!0,name:'instance'});this.callEditor=Ext.create('designer.codeEditor',{readOnly:!1,showSaveBtn:!1,hidden:!0,flex:1,anchor:'100%',hideLabel:!0,sourceCode:'',name:'call',extraKeys:{"Ctrl-Space":function(cm){CodeMirror.simpleHint(cm,CodeMirror.javascriptHint)},"Ctrl-S":function(cm){me.saveData()},"Ctrl-Z":function(cm){me.callEditor.undoAction()},"Ctrl-Y":function(cm){me.callEditor.redoAction()},"Shift-Ctrl-Z":function(cm){me.callEditor.redoAction()}}});this.typeBox=Ext.create('Ext.form.field.ComboBox',{fieldLabel:desLang.propertyType,name:'type',forceSelection:!0,displayField:'title',valueField:'id',allowBlank:!1,store:Ext.create('Ext.data.Store',{model:'app.comboStringModel',data:[{id:'store',title:desLang.store},{id:'instance',title:desLang.instanceOf},{id:'jscall',title:desLang.jsCall}]}),queryMode:'local',listeners:{change:{fn:this.onTypeSelected,scope:this}}});this.dataForm=Ext.create('Ext.form.Panel',{bodyCls:'formBody',layout:{type:'vbox',align:'stretch',pack:'start'},bodyPadding:4,fieldDefaults:{labelWidth:120,labelAlign:'right'},items:[this.typeBox,this.callEditor,this.storeSelect,this.instanceSelect]});this.items=[this.dataForm];this.buttons=[{text:desLang.save,scope:this,handler:this.saveData},{text:desLang.cancel,scope:this,handler:this.close}];this.callParent();this.loadData()},onTypeSelected:function(combo,v){this.callEditor.hide();this.storeSelect.hide();this.instanceSelect.hide();switch(v){case 'instance':this.instanceSelect.show();break;case 'jscall':this.callEditor.show();break;case 'store':default:this.storeSelect.show();break}},loadData:function(){var form=this.dataForm.getForm();var me=this;form.load({waitMsg:desLang.loading,url:this.controllerUrl+'storeload',method:'post',params:{'object':this.objectName,},success:function(form,action){if(action.result.success){if(!Ext.isEmpty(action.result.data.call)){me.callEditor.setValue(action.result.data.call)}
if(!Ext.isEmpty(action.result.data.code)){me.editor.setValue(action.result.data.code)}
me.fireEvent('dataLoaded',action.result)}else{Ext.Msg.alert(desLang.message,action.result.msg).toFront();me.close()}},failure:app.formFailure})},saveData:function(){var me=this;var form=this.dataForm.getForm();form.submit({clientValidation:!0,method:'post',url:this.controllerUrl+'storesave',params:{'object':this.objectName,'call':this.callEditor.getValue()},waitMsg:appLang.SAVING,success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg);return}
me.fireEvent('dataSaved');me.close()},failure:app.formFailure})},destroy:function(){this.storeSelect.destroy();this.instanceSelect.destroy();this.callEditor.destroy();this.typeBox.destroy();this.dataForm.destroy();this.callParent(arguments)}});Ext.define('designer.relatedProjectItemsWindow',{extend:'Ext.Window',title:desLang.relatedProjectItems,width:600,height:500,objectsTree:null,dataStore:null,listUrl:'',layout:'fit',initComponent:function(){this.dataStore=Ext.create('Ext.data.TreeStore',{proxy:{type:'ajax',url:this.listUrl,reader:{type:'json',idProperty:'id'},autoLoad:!1},fields:[{name:'id',type:'string'},{name:'text',type:'string'},{name:'objClass',type:'string'}],root:{text:'/',expanded:!0,id:0,leaf:!1,children:[]},defaultRootId:0,clearOnLoad:!0,autoLoad:!1});this.objectsTree=Ext.create('Ext.tree.Panel',{store:this.dataStore,rootVisible:!1,useArrows:!0});this.items=[this.objectsTree];this.callParent();this.dataStore.getRootNode().removeAll();this.dataStore.load()}});Ext.define('app.FilesystemTree',{extend:'Ext.tree.Panel',controllerUrl:'',listAction:'fslist',folderSort:!0,constructor:function(config){config=Ext.apply({rootVisible:!0,useArrows:!0},config||{});this.callParent(arguments)},initComponent:function(){this.store=Ext.create('Ext.data.TreeStore',{folderSort:!0,fields:[{name:'id',type:'string'},{name:'text',type:'string'},{name:'url',type:'string'}],proxy:{type:'ajax',url:this.controllerUrl+this.listAction,reader:{type:'json',idProperty:'id'}},autoLoad:!1,root:{text:'/',expanded:!0,id:'/'}});this.callParent();this.on('show',function(){app.checkSize(this)})},destroy:function(){this.store.destroy();this.callParent(arguments)}});Ext.define('app.filesystemWindow',{extend:'Ext.Window',width:300,height:500,layout:'fit',fileTree:null,itemForm:null,listAction:'fslist',controllerUrl:'',viewMode:'select',createExtension:'',initComponent:function(){this.fileTree=Ext.create('app.FilesystemTree',{controllerUrl:this.controllerUrl,listAction:this.listAction,split:!0,tbar:[{text:appLang.CREATE_DIR,scope:this,handler:this.makeDir,hidden:(this.viewMode=='select')?true:!1}]});this.items=[this.fileTree];this.buttons=[];switch(this.viewMode){case 'select':this.buttons.push({text:appLang.SELECT,handler:this.onSelectClick,scope:this});break;case 'create':this.buttons.push({text:appLang.CREATE,handler:this.onCreateClick,scope:this});break}
this.buttons.push({text:appLang.CLOSE,handler:this.close,scope:this});this.callParent(arguments);this.on('show',function(){app.checkSize(this)})},makeDir:function(){var me=this;var sm=this.fileTree.getSelectionModel();var path='';Ext.MessageBox.prompt(appLang.MESSAGE,appLang.ENTER_DIR_NAME,function(btn,text){if(btn!='ok'||text.length<1){return}
var item=null;if(sm.hasSelection()){item=sm.getSelection()[0];if(!item.get('leaf')){path=item.get('id')}}
Ext.Ajax.request({url:me.controllerUrl+'fsmakedir',method:'post',params:{'path':path,'name':text},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.fileTree.getStore().load()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})})},onSelectClick:function(){var sm=this.fileTree.getSelectionModel();if(!sm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_SELECT_FILE);return}
var item=sm.getSelection()[0];if(!item.get('leaf')){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_SELECT_FILE);return}
this.fireEvent('fileSelected',item.get('id'),item);this.close()},onCreateClick:function(){var sm=this.fileTree.getSelectionModel();var me=this;if(!sm.hasSelection()){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_SELECT_DIR);return}
Ext.MessageBox.prompt(appLang.MESSAGE,appLang.ENTER_FILE_NAME,function(btn,text){if(btn!='ok'||text.length<1){return}
var item=null;if(sm.hasSelection()){item=sm.getSelection()[0];if(!item.get('leaf')){path=item.get('id')}}
Ext.Ajax.request({url:me.controllerUrl+'fsmakefile',method:'post',params:{'path':path,'name':text},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){me.fireEvent('fileCreated',response.data.file);me.close()}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})})},destroy:function(){this.fileTree.destroy();this.callParent(arguments)}});Ext.ns('app.orm.connections');Ext.define('app.orm.connections.Window',{extend:'Ext.Window',dataGrid:null,dataStore:null,controllerUrl:'',dbConfigs:null,modal:!0,constructor:function(config){config=Ext.apply({title:appLang.DB_CONNECTIONS,width:800,height:300,layout:'fit',closeAction:'destroy',maximizable:!0},config||{});this.callParent(arguments)},initComponent:function(){var me=this;var defaultConnectionId=this.dbConfigs[0].id;this.dataStore=Ext.create('Ext.data.Store',{fields:[{name:'id',type:'string'},{name:'system',type:'boolean'},{name:'devType',type:'integer'},{name:'username',type:'string'},{name:'dbname',type:'string'},{name:'host',type:'string'},{name:'adapter',type:'string'},{name:'isolation',type:'string'}],proxy:{type:'ajax',url:this.controllerUrl+'list',extraParams:{devType:defaultConnectionId},reader:{type:'json',rootProperty:'data',idProperty:'id'},simpleSortMode:!0},remoteSort:!1,autoLoad:!0,sorters:[{property:'id',direction:'DESC'}]});this.filter=Ext.create('Ext.form.field.ComboBox',{typeAhead:!0,triggerAction:'all',selectOnTab:!0,labelWidth:80,forceSelection:!0,queryMode:'local',displayField:'title',valueField:'id',value:defaultConnectionId,store:Ext.create('Ext.data.Store',{fields:[{name:'id',type:'integer'},{name:'title',type:'string'}],data:this.dbConfigs}),listeners:{change:{fn:function(){this.dataStore.proxy.setExtraParam('devType',this.filter.getValue());this.dataStore.load()},scope:this}}});this.dataGrid=Ext.create('Ext.grid.Panel',{store:this.dataStore,frame:!1,loadMask:!0,columnLines:!0,scrollable:!0,forceFit:!0,viewConfig:{stripeRows:!1,enableTextSelection:!0},tbar:[{text:appLang.ADD_ITEM,handler:function(){this.showEditWindow(!1,this.filter.getValue())},scope:this},'-',appLang.TYPE,this.filter],columns:[{xtype:'actioncolumn',width:30,align:'center',dataIndex:'id',items:[{iconCls:'editIcon',scope:this,handler:function(grid,rowIndex,colIndex){var rec=this.dataStore.getAt(rowIndex);this.showEditWindow(rec.get('id'),rec.get('devType'))}}]},{text:appLang.NAME,dataIndex:'id'},{sortable:!0,text:appLang.DB_HOST,dataIndex:'host',align:'center'},{sortable:!0,text:appLang.DB_NAME,dataIndex:'dbname',align:'center'},{sortable:!0,text:appLang.USER,dataIndex:'username',align:'center'},{sortable:!0,text:appLang.DB_ADAPTER,dataIndex:'adapter',align:'center'},{sortable:!0,text:appLang.TRANSACTION_ISOLATION_LEVEL,dataIndex:'isolation',align:'center'},{width:30,align:'center',dataIndex:'system',colid:'deleteindex',renderer:function(value,metaData,record,rowIndex,colIndex,store){if(value){return'<img src="'+app.wwwRoot+'i/system/locked.png" title="'+appLang.SYSTEM_PROTECTED_FIELD+'">'}else{return'<img src="'+app.wwwRoot+'i/system/delete.png" title="'+appLang.DELETE_ITEM+'" style="cursor:pointer;">'}}}],listeners:{'itemdblclick':{fn:function(view,record,number,event,options){this.showEditWindow(record.get('id'),record.get('devType'))},scope:this},'cellclick':{fn:function(grid,cell,columnIndex,record,node,rowIndex,evt){var column=grid.getHeaderCt().getHeaderAtIndex(columnIndex).colid;if(record.get('primary'))
return;switch(column){case 'deleteindex':if(record.get('system')){return}
this.removeItem(record);break}},scope:this}}});this.items=[this.dataGrid];this.callParent();this.on('show',function(){app.checkSize(this)})},removeItem:function(record){Ext.Ajax.request({url:this.controllerUrl+'remove',method:'post',scope:this,params:{'id':record.get('id')},success:function(response,request){response=Ext.JSON.decode(response.responseText);if(response.success){this.dataStore.remove(record)}else{Ext.Msg.alert(appLang.MESSAGE,response.msg)}},failure:function(){Ext.Msg.alert(appLang.MESSAGE,appLang.MSG_LOST_CONNECTION)}})},showEditWindow:function(id,devtype){var win=Ext.create('app.orm.connections.EditWindow',{recordId:id,devType:devtype,controllerUrl:this.controllerUrl});win.on('dataSaved',function(){this.dataStore.load()},this);win.show()}});Ext.define('app.orm.connections.EditWindow',{extend:'Ext.Window',dataForm:null,controllerUrl:'',devType:!1,recordId:!1,constructor:function(config){config=Ext.apply({title:appLang.DB_CONNECTIONS,width:400,height:450,layout:'fit',modal:!0,closeAction:'destroy',maximizable:!1},config||{});this.callParent(arguments)},initComponent:function(){this.dataForm=Ext.create('Ext.form.Panel',{bodyCls:'formBody',bodyPadding:10,fieldDefaults:{anchor:'100%',labelWidth:160},items:[{xtype:'textfield',fieldLabel:appLang.NAME,allowBlank:!1,vtype:'alphanum',value:'',name:'id'},{xtype:'textfield',fieldLabel:appLang.DB_HOST,allowBlank:!1,name:'host'},{xtype:'textfield',fieldLabel:appLang.DB_PORT,allowBlank:!0,name:'port'},{xtype:'textfield',fieldLabel:appLang.DB_NAME,allowBlank:!1,name:'dbname'},{xtype:'textfield',fieldLabel:appLang.DB_CHARSET,allowBlank:!1,value:'UTF8',name:'charset'},{xtype:'textfield',fieldLabel:appLang.DB_PREFIX,name:'prefix'},Ext.create('Ext.form.field.ComboBox',{xtype:'combo',name:'adapter',fieldLabel:appLang.DB_ADAPTER,queryMode:'local',allowBlank:!1,forceSelection:!0,displayField:'title',valueField:'title',value:'Mysqli',store:Ext.create('Ext.data.Store',{fields:[{name:'title',type:'string'}],data:[{title:'Mysqli'}],sorters:[{property:'title',direction:'ASC'}]})}),{xtype:'textfield',fieldLabel:appLang.USER,allowBlank:!1,name:'username'},{name:'setpass',value:1,readOnly:!0,fieldLabel:appLang.CHANGE_PASSWORD,submitValue:!0,checked:!0,xtype:'checkbox',listeners:{change:{fn:this.denyBlankPassword,scope:this,buffer:350}}},{fieldLabel:appLang.PASSWORD,inputType:"password",name:"password",xtype:"textfield",enableKeyEvents:!0,allowBlank:!1},{fieldLabel:appLang.PASSWORD_CONFIRM,inputType:"password",name:"pass2",submitValue:!1,xtype:"textfield",enableKeyEvents:!0,vtype:'password',initialPassField:'password',allowBlank:!1},Ext.create('Ext.form.field.ComboBox',{xtype:'combo',name:'transactionIsolationLevel',fieldLabel:appLang.TRANSACTION_ISOLATION_LEVEL,queryMode:'local',allowBlank:!1,forceSelection:!0,displayField:'title',valueField:'title',value:'default',store:Ext.create('Ext.data.Store',{fields:[{name:'title',type:'string'}],data:[{title:'default'},{title:'READ UNCOMMITTED'},{title:'READ COMMITTED'},{title:'REPEATABLE READ'},{title:'SERIALIZABLE'}],sorters:[{property:'title',direction:'ASC'}]})}),]});this.buttons=[{text:appLang.TEST,scope:this,handler:this.testAction},{text:appLang.SAVE,scope:this,handler:this.saveAction},{text:appLang.CANCEL,scope:this,handler:this.close}];this.items=[this.dataForm];this.callParent(arguments);if(this.recordId){this.dataForm.load({url:this.controllerUrl+'load',params:{id:this.recordId,devType:this.devType},scope:this,success:function(form,action){if(action.result.success){form.findField('setpass').enable();form.findField('setpass').setValue(!1);form.findField('setpass').setReadOnly(!1)}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}},failure:app.formFailure})}},denyBlankPassword:function(field,bool){var handle=this.dataForm.getForm();if(!bool){handle.findField('password').disable();handle.findField('pass2').disable()}else{handle.findField('password').enable();handle.findField('pass2').enable()}
handle.findField('password').allowBlank=!bool;handle.findField('pass2').allowBlank=!bool},saveAction:function(){this.dataForm.getForm().submit({clientValidation:!0,waitMsg:appLang.SAVING,method:'post',scope:this,url:this.controllerUrl+'save',params:{oldid:this.recordId,devType:this.devType},success:function(form,action){if(!action.result.success){Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}else{this.fireEvent('dataSaved');this.close()}},failure:app.formFailure})},testAction:function(){this.dataForm.getForm().submit({clientValidation:!0,waitMsg:appLang.CHECKING,method:'post',scope:this,url:this.controllerUrl+'test',params:{devType:this.devType},success:function(form,action){if(action.result.success){Ext.Msg.alert(appLang.MESSAGE,appLang.SUCCESS)}else{Ext.Msg.alert(appLang.MESSAGE,action.result.msg)}},failure:app.formFailure})}});Ext.onReady(function(){app.menu.hide();designer.controllerUrl=app.root+'sub';app.designer=Ext.create('designer.application',{});app.content.add(app.designer)})